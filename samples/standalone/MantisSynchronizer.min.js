(()=>{"use strict";var t={d:(e,s)=>{for(var i in s)t.o(s,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:s[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};t.d(e,{default:()=>D});const s=window["@mantisvision/utils"];var i,a,h,n,r,l,o,f,u,d,c,_,p=function(t,e,s,i,a){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!a:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?a.call(t,s):a?a.value=s:e.set(t,s),s},b=function(t,e,s,i){if("a"===s&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!i:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?i:"a"===s?i.call(t):i?i.value:e.get(t)};try{if(void 0===s)throw"Missing MantisLog from @mantisvision/utils";var y=s.MantisLog}catch(t){y={debug:(...t)=>{}}}!function(t){t[t.paused=0]="paused",t[t.playing=1]="playing"}(_||(_={})),i=new WeakMap,a=new WeakMap,h=new WeakMap,n=new WeakMap,r=new WeakMap,l=new WeakMap,o=new WeakMap,f=new WeakMap,u=new WeakMap,d=new WeakMap,c=new WeakMap;var g;!function(t){t.timeupdate="timeupdate",t.durationchange="durationchange",t.ended="ended",t.paused="paused",t.playing="playing",t.buffering="buffering",t.buffered="buffered"}(g||(g={}));var m,w,k,v,S,P,j,O,L,A,T,M,E=function(t,e,s,i,a){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!a:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?a.call(t,s):a?a.value=s:e.set(t,s),s},R=function(t,e,s,i){if("a"===s&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!i:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?i:"a"===s?i.call(t):i?i.value:e.get(t)};!function(t){t[t.paused=0]="paused",t[t.forcedPause=1]="forcedPause",t[t.buffering=2]="buffering",t[t.playing=3]="playing"}(T||(T={})),function(t){t.error="error",t.buffering="buffering",t.buffered="buffered",t.disposed="disposed"}(M||(M={})),m=new WeakMap,w=new WeakMap,k=new WeakMap,v=new WeakMap,S=new WeakMap,P=new WeakMap,j=new WeakMap,O=new WeakMap,L=new WeakMap,A=new WeakMap;var V,C,z=function(t,e,s,i){if("a"===s&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!i:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?i:"a"===s?i.call(t):i?i.value:e.get(t)};try{if(void 0===s)throw"Missing MantisLog from @mantisvision/utils";var F=s.MantisLog}catch(t){F={debug:(...t)=>{}}}V=new WeakSet,C=function(){return F.debug("playUser called internally! userstate: "+this._userStatePlay+" libstate: "+this._libStatePlay,"pink","black"),this._playUser()};const D=class{constructor(t){for(var e of(V.add(this),this._playbackRate=1,this._destroyed=!1,this._synchronizableObjects=new Map,this._timingObject=null,this._currentTimestamp=0,this._pausedTimestamp=0,this._syncObjs=new Map,this._looping=new Set,this._ended=new Map,this._buffering=new Map,this._listeners=new Map,this._fullDuration=0,this._firstStart=!0,this._autostart=!1,this._autostartAfter=-1,this._firstBuffered=0,this._paused=!0,this._volume=0,this._callbacks=new Map,this._userStatePlay=-1,this._libStatePlay=0,this._promise=null,this._timeupdate=()=>{if(this._timingObject&&!this.isPaused()&&1===this._userStatePlay&&1===this._libStatePlay){const t=this._timingObject.query().position;if(this._currentTimestamp=t,t>=.5){const e=this._syncObjs.entries();let s;for(;s=e.next().value;)if(s[1]>=t){const e=s[0].getCurrentTime()-t;e<.1&&e>-.1?s[0].playbackRate!==this._playbackRate&&(s[0].playbackRate=this._playbackRate):e>1||e<-1?(s[0].playbackRate!==this._playbackRate&&(s[0].playbackRate=this._playbackRate),s[0].jumpAt(t)):s[0].playbackRate=e>=.1?e<.3?.9*this._playbackRate:e<.7?.8*this._playbackRate:e<1?.75*this._playbackRate:.7*this._playbackRate:e<-1?1.3*this._playbackRate:e<-.7?1.25*this._playbackRate:e<-.3?1.2*this._playbackRate:1.1*this._playbackRate}this._callCallbacks(g.timeupdate,t)}}},this._timingClass=t,Object.keys(g)))this._callbacks.set(e,new Set)}setPlaybackRate(t){const e=this._playbackRate;if(this._playbackRate=t,e!==t){const e=this._synchronizableObjects.values();for(var s;s=e.next().value;)s.playbackRate=t;this._timingObject?.update({velocity:this._playbackRate})}return this}getDuration(){return this._fullDuration}getCurrentTimestamp(){return this._currentTimestamp}autoplayAfter(t){return this._destroyed||(F.debug("Play after "+t+" added media","yellow","black"),this._firstStart&&(t-this._buffering.size-this._ended.size-this._syncObjs.size<=0?(this._firstStart=!1,this.play()):this._autostartAfter=t),this.setAutoplay(!0)),this}setLoop(t,e){if(this._destroyed)return this;if(Array.isArray(t))for(var s of t)this.setLoop(s,e);else{const s=this._synchronizableObjects.get(t);if(!s)throw new Error("Media hasn't been added to this VideoSync object (or it was already removed).");this._setLoop(s,e)}return this}isPaused(){return this._paused}isAutoplay(){return this._autostart}setVolume(t,e){if(void 0===e){const e=this._listeners.keys();let s;for(;s=e.next().value;)s.setVolume(t);this._volume=t}else if(Array.isArray(e))for(var s of e)this.setVolume(t,s);else if(this._synchronizableObjects.has(e)){const s=this._synchronizableObjects.get(e);s?.setVolume(t)}return this}setAutoplay(t){return t&&!this._autostart&&this._firstStart?(this._paused=!1,this._autostart=t,this._checkAutoplay()):this._autostart=t,this}on(t,e){return this._destroyed||this._callbacks.get(t)?.add(e),this}off(t,e){return this._callbacks.get(t)?.delete(e),this}getMedia(){return[...this._synchronizableObjects.keys()]}async addMedia(t){if(!this._destroyed){if(this._firstStart&&this._autostartAfter<0&&this._autostart)if(Array.isArray(t)){if(!(t.length>0))return;this.autoplayAfter(t.length)}else this.autoplayAfter(1);if(Array.isArray(t)){const s=[];for(var e of t)s.push(this.addMedia(e));await Promise.all(s)}else if(!this._synchronizableObjects.has(t)){let e;e=t instanceof HTMLMediaElement?new class{constructor(t){i.set(this,void 0),a.set(this,void 0),h.set(this,void 0),n.set(this,1),r.set(this,_.paused),l.set(this,[]),o.set(this,[]),f.set(this,!1),u.set(this,this.loopVideo.bind(this)),d.set(this,this.private_checkForcedPause.bind(this)),c.set(this,null),p(this,i,t,"f"),p(this,f,t.loop,"f"),p(this,r,t.paused?_.paused:_.playing,"f"),t.loop=!1;const e="requestVideoFrameCallback"in HTMLMediaElement.prototype?"loadedmetadata":"loadeddata";p(this,a,new Promise(((t,e)=>{p(this,h,t,"f")})),"f"),b(this,i,"f")?.addEventListener("canplay",(()=>y.debug("Canplay was fired","purple"))),b(this,i,"f")?.addEventListener("waiting",(()=>y.debug("Waiting was fired","purple"))),b(this,i,"f")?.addEventListener(e,(()=>{y.debug(e+" was fired","purple"),b(this,h,"f")&&b(this,i,"f")&&b(this,h,"f").call(this,b(this,i,"f").duration)}))}getMediaElement(){return b(this,i,"f")}setVolume(t){t!==b(this,n,"f")&&b(this,i,"f")&&(p(this,n,t,"f"),b(this,i,"f").volume=t,b(this,i,"f").muted=t<=0)}async play(){b(this,i,"f")&&(p(this,r,_.playing,"f"),await b(this,a,"f"),b(this,r,"f")===_.playing&&null===b(this,c,"f")&&b(this,i,"f")&&(b(this,i,"f").volume=0,b(this,i,"f").muted=!0,p(this,c,b(this,i,"f").play(),"f"),await b(this,c,"f"),this.private_IOSFix(),p(this,c,null,"f")))}async pause(){b(this,i,"f")&&b(this,r,"f")===_.playing&&(p(this,r,_.paused,"f"),b(this,c,"f")&&await b(this,c,"f"),b(this,r,"f")===_.paused&&b(this,i,"f")&&b(this,i,"f").pause())}async jumpAt(t){b(this,i,"f")&&(b(this,i,"f").volume=0,b(this,i,"f").muted=!0,"fastSeek"in b(this,i,"f")?b(this,i,"f").fastSeek(t):b(this,i,"f").currentTime=t,this.private_IOSFix())}on(t,e){b(this,i,"f")&&"durationchange"!==t&&b(this,i,"f").addEventListener(t,e)}off(t,e){b(this,i,"f")&&"durationchange"!==t&&b(this,i,"f").removeEventListener(t,e)}onDestroy(t){return b(this,o,"f").push(t),this}onTimeUpdate(t){return b(this,i,"f")&&b(this,i,"f").addEventListener("timeupdate",t),this}offTimeUpdate(t){return b(this,i,"f")&&b(this,i,"f").removeEventListener("timeupdate",t),this}async stop(){p(this,r,_.paused,"f"),b(this,i,"f")&&(await b(this,i,"f").pause(),b(this,i,"f").currentTime=0)}async getDuration(){return await b(this,a,"f")}getCurrentTime(){return b(this,i,"f")?b(this,i,"f").currentTime:0}onForcedPause(t){return b(this,l,"f").push(t),this}offForcedPause(t){for(var e=0;e<b(this,l,"f").length;e++)if(b(this,l,"f")[e]===t){b(this,l,"f").splice(e,1);break}return this}set loop(t){p(this,f,t,"f"),t?b(this,i,"f").addEventListener("ended",b(this,u,"f")):b(this,i,"f").removeEventListener("ended",b(this,u,"f"))}get loop(){return b(this,f,"f")}get readyState(){return b(this,i,"f").readyState}set playbackRate(t){b(this,i,"f").playbackRate=t}get playbackRate(){return b(this,i,"f")?b(this,i,"f").playbackRate:0}finish(){for(var t of(b(this,i,"f").removeEventListener("pause",b(this,d,"f")),b(this,i,"f").removeEventListener("ended",b(this,u,"f")),b(this,o,"f")))t(void 0);p(this,o,[],"f"),p(this,l,[],"f")}private_IOSFix(){setTimeout((()=>{b(this,i,"f")&&(b(this,i,"f").addEventListener("pause",b(this,d,"f")),setTimeout((()=>{b(this,i,"f")&&b(this,i,"f").removeEventListener("pause",b(this,d,"f"))}),1e3),b(this,i,"f").volume=b(this,n,"f"),b(this,i,"f").muted=b(this,n,"f")<=0)}),250)}loopVideo(){b(this,i,"f")&&(p(this,r,_.playing,"f"),b(this,i,"f").volume=0,b(this,i,"f").muted=!0,b(this,i,"f").currentTime=0,b(this,i,"f").play().then(this.private_IOSFix.bind(this)))}private_checkForcedPause(){if(b(this,i,"f")&&b(this,r,"f")===_.playing)for(var t of(b(this,i,"f").removeEventListener("pause",b(this,d,"f")),b(this,l,"f")))t()}}(t):("getMesh"in(s=t)||"getEntity"in s)&&"run"in s?new class{constructor(t){m.set(this,T.paused),w.set(this,1),k.set(this,!1),v.set(this,void 0),S.set(this,null),P.set(this,!1),j.set(this,this.loopVideo.bind(this)),O.set(this,this.private_checkForcedPause.bind(this)),L.set(this,[]),A.set(this,null),E(this,v,t,"f"),E(this,m,t.isPaused()?T.paused:T.playing,"f"),E(this,P,t.loop,"f"),R(this,v,"f").loop=!1,R(this,v,"f").on(M.error,(t=>{E(this,k,t,"f"),R(this,S,"f")&&R(this,S,"f").call(this,t)})),R(this,v,"f").on(M.buffering,(()=>E(this,m,T.buffering,"f"))),R(this,v,"f").on(M.buffered,(()=>{R(this,m,"f")!==T.paused&&R(this,m,"f")!==T.forcedPause&&E(this,m,T.playing,"f")}))}getMediaElement(){var t=null;return R(this,v,"f")&&(t=R(this,v,"f").getVideoElement()),t}getRYSKObject(){return R(this,v,"f")}async getDuration(){return R(this,v,"f")?await R(this,v,"f").getDuration():null}async jumpAt(t){R(this,v,"f")&&(R(this,v,"f").setVolume(0),await R(this,v,"f").jumpAt(t),this.private_IOSFix())}getCurrentTime(){return R(this,v,"f")?R(this,v,"f").getCurrentTime():0}on(t,e){R(this,v,"f")&&"durationchange"!==t&&R(this,v,"f").on(t,e)}off(t,e){R(this,v,"f")&&"durationchange"!==t&&R(this,v,"f").off(t,e)}onDestroy(t){return R(this,v,"f")&&R(this,v,"f").on(M.disposed,t),this}onForcedPause(t){return R(this,L,"f").push(t),this}offForcedPause(t){for(var e=0;e<R(this,L,"f").length;e++)if(R(this,L,"f")[e]===t){R(this,L,"f").splice(e,1);break}return this}set loop(t){null!==R(this,v,"f")&&(E(this,P,t,"f"),t?R(this,v,"f").onVideoEvent("ended",R(this,j,"f")):R(this,v,"f").offVideoEvent("ended",R(this,j,"f")))}get loop(){return R(this,P,"f")}get readyState(){return R(this,v,"f")&&R(this,v,"f").firstBuffering?4:0}set playbackRate(t){const e=this.getMediaElement();e&&(e.playbackRate=t)}get playbackRate(){const t=this.getMediaElement();return t?t.playbackRate:0}async play(){if(E(this,m,T.playing,"f"),R(this,v,"f")&&(R(this,v,"f").setVolume(0),await R(this,v,"f").play()),this.private_IOSFix(),R(this,A,"f")){const t=R(this,A,"f");E(this,A,null,"f"),t()}}async pause(){E(this,m,T.paused,"f"),R(this,v,"f")&&await R(this,v,"f").pause()}async stop(){E(this,m,T.paused,"f"),R(this,v,"f")&&await R(this,v,"f").stop()}setVolume(t){t!==R(this,w,"f")&&(E(this,w,t,"f"),R(this,v,"f")&&R(this,v,"f").setVolume(t))}finish(){E(this,L,[],"f"),R(this,v,"f")&&(R(this,v,"f").offVideoEvent("ended",R(this,j,"f")),R(this,v,"f").offVideoEvent("pause",R(this,O,"f")),R(this,v,"f").pause(),E(this,v,null,"f"))}loopVideo(){null!==R(this,v,"f")&&(E(this,m,T.paused,"f"),R(this,v,"f").setVolume(0),R(this,v,"f").jumpAt(0).then((()=>R(this,v,"f")?.play())).then(this.private_IOSFix.bind(this)))}private_IOSFix(){setTimeout((()=>{null!==R(this,v,"f")&&(R(this,v,"f").onVideoEvent("pause",R(this,O,"f")),setTimeout((()=>{null!==R(this,v,"f")&&R(this,v,"f").offVideoEvent("pause",R(this,O,"f"))}),250),R(this,v,"f").setVolume(R(this,w,"f")))}),250)}private_checkForcedPause(){if(null!==R(this,v,"f")&&R(this,m,"f")===T.playing)for(var t of(R(this,v,"f").offVideoEvent("pause",R(this,O,"f")),R(this,L,"f")))t()}}(t):t,this._synchronizableObjects.set(t,e),await this._addMedia(e)}var s}}removeMedia(t){if(Array.isArray(t))for(var e of t)this.removeMedia(e);else{const e=this._synchronizableObjects.get(t);e&&(this._removeMedia(e),this._synchronizableObjects.delete(t))}return this}finish(){if(this._destroyed=!0,this._timingObject){try{this._timingUpdateHandler&&(this._timingObject.off(this._timingUpdateHandler),this._timingUpdateHandler=void 0)}catch(t){console.error(t)}this._timingObject.update({velocity:0}),this._timingObject=null}this._listeners.forEach(((t,e)=>{this._detachAllListeners(e),e.playbackRate=this._playbackRate})),this._listeners.clear(),this._looping.forEach((t=>t.loop=!0)),this._looping.clear(),this._syncObjs.clear(),this._buffering.clear(),this._ended.clear(),this._longestMedia=void 0,this._callbacks.clear()}async play(){this._destroyed||(this._firstStart&&(this._firstStart=!1),this._paused=!1,F.debug("Played called externally! userstate: "+this._userStatePlay+" libstate: "+this._libStatePlay,"lime","black"),await this._playUser())}async pause(){this._destroyed||(this._paused=!0,F.debug("pause called externally! userstate: "+this._userStatePlay+" libstate: "+this._libStatePlay,"lime","black"),await this._pauseUser())}async jumpAt(t){if(this._destroyed)return;F.debug("Jumping to "+t,"yellow","black"),await this._pauseLib(),this._callCallbacks(g.timeupdate,t),this._currentTimestamp=t,this._ended.forEach(((e,s)=>{e>=t&&(this._syncObjs.set(s,e),this._ended.delete(s))}));const e=[];this._buffering.forEach(((s,i)=>{s>=t?this._syncObjs.set(i,s):(this._ended.set(i,s),e.push(i.jumpAt(s)))})),this._buffering.clear(),await Promise.allSettled(e),await this._resetSync(t),this._pausedTimestamp>0&&(this._pausedTimestamp=t);const s=[this._syncObjs.entries(),this._buffering.entries()];let i,a=null,h=0;for(var n of s)for(;i=n.next().value;)i[1]>h&&(h=i[1],a=i[0]);a&&this._longestMedia!==a&&(this._longestMedia=a,this._fullDuration=h,this._callCallbacks(g.durationchange,h)),this._timingObject&&this._timingObject.update({position:t,velocity:0}),0===this._buffering.size&&await this._playLib()}async stop(){if(this._destroyed)return;if(await this.pause(),this._timingObject){try{this._timingUpdateHandler&&(this._timingObject.off(this._timingUpdateHandler),this._timingUpdateHandler=void 0)}catch(t){console.error(t)}this._timingObject.update({velocity:0}),this._timingObject=null,this._callCallbacks(g.timeupdate,0)}this._currentTimestamp=0,this._pausedTimestamp=0,this._ended.forEach(((t,e)=>{this._syncObjs.set(e,t)})),this._ended.clear(),this._buffering.forEach(((t,e)=>{this._syncObjs.set(e,t)})),this._buffering.clear();const t=[],e=this._syncObjs.entries();let s,i=null,a=0;for(;s=e.next().value;)t.push(s[0].stop()),s[1]>a&&(a=s[1],i=s[0]);i&&i!==this._longestMedia&&(this._longestMedia=i,this._fullDuration=a,this._callCallbacks(g.durationchange,a)),await Promise.allSettled(t),await this._playLib()}_setLoop(t,e){F.debug("Setting loop to: "+e,"yellow","black"),t.loop=!1,e?this._looping.add(t):this._looping.delete(t)}async _addMedia(t){if(!this._listeners.has(t)){t.setVolume(this._volume),this._listeners.set(t,new Map),this._setLoop(t,t.loop);const e=await t.getDuration();if(F.debug("Is this paused? "+this.isPaused(),"aqua","black"),null!==e){t.loop=!1;const s=this._currentTimestamp;let i=!1;e<s&&(F.debug("New Video already ends "+s+" duration is "+e,"yellow","black"),this._ended.set(t,e),i=!0),U(t)?this._attachListenersToSYK(t,e):x(t)&&this._attachListenersToVideo(t,e),this._fullDuration<e?(this._fullDuration=e,this._longestMedia=t,Math.abs(t.getCurrentTime()-s)>=.5&&(F.debug("New media jumps to timestamp "+s,"yellow","black"),t.jumpAt(s)),this._callCallbacks(g.durationchange,this._fullDuration)):s<=e&&Math.abs(t.getCurrentTime()-s)>=.5&&(F.debug("New media jumps to timestamp "+s,"yellow","black"),t.jumpAt(s)),this._firstStart?this._checkAutoplay():this.isPaused()?t.pause():i||t.play()}}}_removeMedia(t){if(this._listeners.has(t)){this._autostartAfter--;const e=this._buffering.has(t);if(this._detachAllListeners(t),this._looping.has(t)&&(this._looping.delete(t),t.loop=!0),this._syncObjs.delete(t),this._ended.delete(t),this._buffering.delete(t),this._longestMedia===t&&this._lookForLongest(),this._syncObjs.size+this._ended.size+this._buffering.size===0){if(this._timingObject){try{this._timingUpdateHandler&&(this._timingObject.off(this._timingUpdateHandler),this._timingUpdateHandler=void 0)}catch(t){console.error(t)}this._timingObject.update({velocity:0}),this._timingObject=null}this._currentTimestamp=0,this._pausedTimestamp=0,this._longestMedia=void 0,this._fullDuration=0,this._callCallbacks(g.durationchange,0)}else e&&0===this._buffering.size&&this._syncObjs.size>0&&this._playLib()}return this}async _loopVideos(){if(!this.isPaused()){var t=this._looping.values();let e;for(F.debug("Looping "+this._looping.size+" media","aqua","black");e=t.next().value;)e.playbackRate!==this._playbackRate&&(e.playbackRate=this._playbackRate),e.loopVideo()}}async _resetSync(t=0){const e=[],s=[];var i=this._syncObjs.entries();let a;for(;a=i.next().value;)if(a[0].playbackRate!==this._playbackRate&&(a[0].playbackRate=this._playbackRate),a[1]>=t){if(e.push(a[0].jumpAt(t)),x(a[0])&&0===t){const t=a[0].getMediaElement();t&&s.push(t.play())}}else this._ended.set(a[0],a[1]),await a[0].jumpAt(a[1]),this._syncObjs.delete(a[0]);await Promise.allSettled(e),await Promise.allSettled(s)}_lookForLongestAfterLoop(){let t,e=this._looping.values(),s=null,i=0;for(F.debug("Looking for the new longest from among "+this._ended.size+" ended and "+this._looping.size+" looping","aqua","black");t=e.next().value;){const e=this._syncObjs.get(t);e&&(e>i||null===s)&&(i=e,s=t)}s&&s!==this._longestMedia&&(this._longestMedia=s,this._fullDuration=i,F.debug("Found the new longest duration: "+i,"aqua","black"),this._callCallbacks(g.durationchange,i))}_lookForLongest(){for(var t=null,e=0,s=[this._syncObjs.entries(),this._buffering.entries(),this._ended.entries()],i=0;i<s.length;i++){let a,h=s[i];for(;a=h.next().value;)2===i&&this._looping.has(a[0])||a[1]>e&&(e=a[1],t=a[0])}return null!==t&&(this._longestMedia=t,this._fullDuration=e,this._currentTimestamp>e&&this._lastVideoHasEnded(t,e),this._callCallbacks(g.durationchange,e),!0)}_checkAutoplay(){F.debug("Checking autoplay: "+this._autostart+" First start: "+this._firstStart+" Autostart after: "+this._autostartAfter+" first buffered: "+this._firstBuffered,"aqua","black"),this._autostart&&this._firstStart&&this._autostartAfter>=0&&this._firstBuffered===this._autostartAfter&&(this._firstStart=!1,this._playLib(),this.isPaused()||this.play())}_detachAllListeners(t){const e=this._listeners.get(t);if(e){const s=e.entries();let i;for(;i=s.next().value;)switch(i[0]){case"buffering":U(t)?t.off("buffering",i[1]):x(t)&&t.off("waiting",i[1]);break;case"buffered":U(t)?t.off("buffered",i[1]):x(t)&&t.off("canplaythrough",i[1]);break;case"canplay":U(t)?t.off("dataBuffered",i[1]):x(t)&&t.off("canplaythrough",i[1]);break;case"ended":U(t)?t.off("video.ended",i[1]):x(t)&&t.off("ended",i[1])}this._listeners.delete(t)}return this}_attachListenersToSYK(t,e){F.debug("Attaching to RYSK object","yellow","black"),this._firstStart?t.readyState<2?(this._buffering.set(t,e),1===this._buffering.size&&this._callCallbacks(g.buffering),this._attachFirstBufferingListenerToSyk(t,e)):(this._syncObjs.set(t,e),this._firstBuffered++,this._checkAutoplay(),(this._firstStart||this.isPaused())&&t.pause()):this._ended.has(t)||this._syncObjs.set(t,e),this._attachBufferingListenerToSyk(t,e)._attachBufferedListenerToSyk(t,e)._attachEndedListenerToSyk(t,e)._attachDurationChangeListener(t)}_attachFirstBufferingListenerToSyk(t,e){const s=this._listeners.get(t);if(!s||s.has("canplay"))throw"Attempt to attach second listener to ended";{const i=()=>{F.debug("RYSK first buffering is finished","yellow","black");const s=this._listeners.get(t);s&&(s.delete("canplay"),t.off("dataBuffered",i),this._currentTimestamp>e?this._ended.set(t,e):this._syncObjs.set(t,e),this._buffering.delete(t),this._firstStart&&this._firstBuffered++,0===this._buffering.size&&(this._playLib(),this.isPaused()||this._firstStart||z(this,V,"m",C).call(this),this._callCallbacks(g.buffered)),this._checkAutoplay())};s.set("canplay",i),t.on("dataBuffered",i)}return this}_attachEndedListenerToSyk(t,e){const s=this._listeners.get(t);if(!s||s.has("ended"))throw"Attempt to attach second listener to video.ended";{const i=()=>{this._videoHasEnded(t,e)};s.set("ended",i),t.on("video.ended",i)}return this}_attachBufferingListenerToSyk(t,e){const s=this._listeners.get(t);if(!s||s.has("buffering"))throw"Attempt to attach second listener to buffering";{const i=()=>{this._ended.has(t)||(this._buffering.set(t,e),this._syncObjs.delete(t),1===this._buffering.size&&this._callCallbacks(g.buffering),this._pauseLib().then((()=>{F.debug("After pause the "+this._buffering.size+" objects still buffering","yellow","black")})))};s.set("buffering",i),t.on("buffering",i)}return this}_attachBufferedListenerToSyk(t,e){const s=this._listeners.get(t);if(!s||s.has("buffered"))throw"Attempt to attach second listener to buffered";{const i=()=>{!this._ended.has(t)&&this._buffering.has(t)&&(this._currentTimestamp>e?this._ended.set(t,e):this._syncObjs.set(t,e),this._buffering.delete(t),0===this._buffering.size?(this._playLib(),this.isPaused()?t.pause():z(this,V,"m",C).call(this),this._callCallbacks(g.buffered)):-1!==this._userStatePlay&&-1!==this._libStatePlay||t.pause())};s.set("buffered",i),t.on("buffered",i)}return this}_attachDurationChangeListener(t){t.on("durationchange",(()=>{t.getDuration().then((e=>{F.debug("Duration of one of media changes to "+e),null!==e&&(this._syncObjs.has(t)&&this._syncObjs.set(t,e),this._ended.has(t)&&this._ended.set(t,e),this._buffering.has(t)&&this._buffering.set(t,e),e<this._currentTimestamp&&!this._ended.has(t)?(this._syncObjs.delete(t),this._buffering.delete(t),this._ended.set(t,e),t.stop()):e>this._currentTimestamp&&this._ended.has(t)&&(this._ended.delete(t),this._syncObjs.set(t,e),t.jumpAt(this._currentTimestamp).then((()=>{this.isPaused()||-1===this._libStatePlay?t.pause():t.play()}))),t===this._longestMedia&&(e<this._fullDuration?this._lookForLongest()||(this._fullDuration=e,this._lastVideoHasEnded(t,e)):(this._fullDuration=e,this._callCallbacks(g.durationchange,e))))}))}))}_attachListenersToVideo(t,e){this._firstStart?t.readyState>=4?(F.debug("New video is already in state "+t.readyState,"yellow","black"),this._syncObjs.set(t,e),this._firstBuffered++,this._checkAutoplay(),(this.isPaused()||this._firstStart)&&t.pause()):(t.play(),this._buffering.set(t,e),1===this._buffering.size&&this._callCallbacks(g.buffering),this._attachCanPlayListenerToVideo(t,e)):this._ended.has(t)||this._syncObjs.set(t,e),this._attachEndedListenerToVideo(t,e)._attachBufferingListenerToVideo(t,e)._attachBufferedListenerToVideo(t,e)._attachDurationChangeListener(t)}_attachCanPlayListenerToVideo(t,e){const s=this._listeners.get(t);if(!s||s.has("canplay"))throw"Attempt to attach second listener to ended";{const i=()=>{F.debug("Video first buffering is finished","yellow","black");const s=this._listeners.get(t);s&&(s.delete("canplay"),t.off("canplaythrough",i),this._currentTimestamp>e?this._ended.set(t,e):this._syncObjs.set(t,e),this._buffering.delete(t),this._firstStart&&this._firstBuffered++,0===this._buffering.size&&(this._playLib(),this.isPaused()||this._firstStart||z(this,V,"m",C).call(this),this._callCallbacks(g.buffered)),this._checkAutoplay(),(this._firstStart||this.isPaused())&&t.pause())};s.set("canplay",i),t.on("canplaythrough",i),F.debug("Video first buffering listener attached. Current state is: "+t.readyState,"yellow","black")}return this}_attachEndedListenerToVideo(t,e){const s=this._listeners.get(t);if(!s||s.has("ended"))throw"Attempt to attach second listener to ended";{const i=()=>{this._videoHasEnded(t,e)};s.set("ended",i),t.on("ended",i)}return this}_attachBufferingListenerToVideo(t,e){const s=this._listeners.get(t);if(!s||s.has("buffering"))throw"Attempt to attach second listener to waiting";{const i=()=>{this._firstStart||this._ended.has(t)||(this._pauseLib(),this._buffering.set(t,e),this._syncObjs.delete(t),1===this._buffering.size&&this._callCallbacks(g.buffering))};s.set("buffering",i),t.on("waiting",i)}return this}_attachBufferedListenerToVideo(t,e){const s=this._listeners.get(t);if(!s||s.has("buffered"))throw"Attempt to attach second listener to playing";{const i=()=>{this._firstStart||(this._currentTimestamp>e?this._ended.set(t,e):this._syncObjs.set(t,e),this._buffering.delete(t),0===this._buffering.size?(this._playLib(),this.isPaused()?t.pause():z(this,V,"m",C).call(this),this._callCallbacks(g.buffered)):-1!==this._userStatePlay&&-1!==this._libStatePlay||t.pause())};s.set("buffered",i),t.on("canplaythrough",i)}return this}async _lastVideoHasEnded(t,e){F.debug("Last video has ended","black","red"),this._buffering.forEach(((t,e)=>{this._syncObjs.set(e,t)})),this._buffering.clear(),this._ended.forEach(((t,e)=>{(this._looping.has(e)||0===this._looping.size)&&(this._syncObjs.set(e,t),this._ended.delete(e))})),await this._pauseLib(),this._currentTimestamp=0,this._pausedTimestamp=0,this._loopVideos(),this._callCallbacks(g.timeupdate,0),this._looping.has(t)?this._timingObject&&this._timingObject.update({position:0,velocity:0}):this._looping.size>0?(this._syncObjs.delete(t),this._ended.set(t,e),this._lookForLongestAfterLoop(),this._timingObject&&this._timingObject.update({position:0,velocity:0})):(null!==this._timingObject&&(this._timingObject.update({velocity:0}),this._timingObject=null),await this.pause(),this._callCallbacks(g.ended)),await this._playLib()}async _videoHasEnded(t,e){this._ended.set(t,e),this._syncObjs.delete(t),this._buffering.delete(t),F.debug("Video has ended, "+this._syncObjs.size+" playing","aqua","black"),0===this._syncObjs.size&&0===this._buffering.size&&await this._lastVideoHasEnded(t,e)}async _playUser(){if(this._promise){this._userStatePlay=0;try{return await this._promise,this._promise=null,void(-1!==this._libStatePlay&&-1!==this._userStatePlay&&(this._userStatePlay=1,this._libStatePlay=1))}catch(t){throw this._promise=null,this._userStatePlay=-1,t}}else{if(this._libStatePlay>-1&&this._userStatePlay>-1){this._userStatePlay=1,this._libStatePlay=1,this._promise=this._playAll();try{await this._promise,this._promise=null,-1!==this._libStatePlay&&-1!==this._userStatePlay&&(this._userStatePlay=1,this._libStatePlay=1)}catch(t){throw this._promise=null,t}return}if(-1===this._libStatePlay)return void(this._userStatePlay=0);if(-1!==this._userStatePlay)throw"Unknown state";this._userStatePlay=0,this._promise=this._playAll();try{return await this._promise,this._promise=null,void(-1!==this._libStatePlay&&-1!==this._userStatePlay&&(this._userStatePlay=1,this._libStatePlay=1))}catch(t){throw this._promise=null,this._userStatePlay=-1,t}}}async _pauseUser(){if(F.debug("pauseUser userstate: "+this._userStatePlay+" libstate: "+this._libStatePlay,"pink","black"),this._userStatePlay=-1,this._promise)try{await this._promise,this._promise=null,-1===this._userStatePlay&&await this._pauseAll()}catch(t){this._promise=null}else await this._pauseAll()}async _playLib(){if(F.debug("playLib userstate: "+this._userStatePlay+" libstate: "+this._libStatePlay,"pink","black"),this._promise){this._libStatePlay=0;try{return await this._promise,this._promise=null,void(-1!==this._libStatePlay&&-1!==this._userStatePlay&&(this._userStatePlay=1,this._libStatePlay=1))}catch(t){throw this._promise=null,this._libStatePlay=-1,t}}else{if(this._libStatePlay>-1&&this._userStatePlay>-1){this._userStatePlay=1,this._libStatePlay=1,this._promise=this._playAll();try{await this._promise,this._promise=null,-1!==this._libStatePlay&&-1!==this._userStatePlay&&(this._userStatePlay=1,this._libStatePlay=1)}catch(t){throw this._promise=null,t}return}if(-1===this._userStatePlay)return void(this._libStatePlay=0);if(-1!==this._libStatePlay)throw"Unknown state";this._libStatePlay=0,this._promise=this._playAll();try{return await this._promise,this._promise=null,void(-1!==this._libStatePlay&&-1!==this._userStatePlay&&(this._userStatePlay=1,this._libStatePlay=1))}catch(t){throw this._promise=null,this._libStatePlay=-1,t}}}async _pauseLib(){if(F.debug("pauseLib userstate: "+this._userStatePlay+" libstate: "+this._libStatePlay,"pink","black"),this._libStatePlay=-1,this._promise)try{await this._promise,this._promise=null,-1===this._libStatePlay&&await this._pauseAll()}catch(t){this._promise=null}else await this._pauseAll()}async _playAll(){if(this._syncObjs.size>0){null!==this._timingObject||this._destroyed?null===this._timingObject||this._destroyed||(F.debug("PLAY ALL "+this._syncObjs.size+" media after pause","yellow","black"),this._timingObject.update({velocity:this._playbackRate})):(F.debug("PLAY ALL "+this._syncObjs.size+" media for the first time","yellow","black"),this._timingObject=new this._timingClass({position:this._currentTimestamp,velocity:this._playbackRate,acceleration:0}),this._timingObject.update({velocity:this._playbackRate}),this._timingUpdateHandler&&this._timingObject.off(this._timingUpdateHandler),this._timingUpdateHandler=this._timingObject.on("timeupdate",this._timeupdate));const t=this._syncObjs.entries();let e;for(;e=t.next().value;)e[0].play();F.debug("PLAY ALL FINISHED","yellow","black"),this._callCallbacks(g.playing)}}async _pauseAll(){F.debug("PAUSE ALL","yellow","black"),this._timingObject&&this._timingObject.update({velocity:0});const t=[];let e,s=this._synchronizableObjects.values();for(;e=s.next().value;)t.push(e.pause());await Promise.allSettled(t),this._callCallbacks(g.paused)}_callCallbacks(t,e){const s=this._callbacks.get(t);if(s){const t=s.values();let i;for(;i=t.next().value;)i(e)}}};function U(t){return"getRYSKObject"in t&&"getMediaElement"in t}function x(t){return!("getRYSKObject"in t)&&"getMediaElement"in t}window.RyskSynchronizer=e.default})();