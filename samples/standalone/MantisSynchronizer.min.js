(()=>{"use strict";var t={d:(e,i)=>{for(var s in i)t.o(i,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:i[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};t.d(e,{default:()=>q});const i=window["@mantisvision/utils"];var s,a,h,r,n,l,o,f,u,c,_,d,p=function(t,e,i,s,a){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!a:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?a.call(t,i):a?a.value=i:e.set(t,i),i},y=function(t,e,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!s:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(t):s?s.value:e.get(t)};try{if(void 0===i)throw"Missing MantisLog from @mantisvision/utils";var b=i.MantisLog}catch(t){b={debug:(...t)=>{}}}!function(t){t[t.paused=0]="paused",t[t.playing=1]="playing"}(d||(d={})),s=new WeakMap,a=new WeakMap,h=new WeakMap,r=new WeakMap,n=new WeakMap,l=new WeakMap,o=new WeakMap,f=new WeakMap,u=new WeakMap,c=new WeakMap,_=new WeakMap;const g=class{constructor(t){s.set(this,void 0),a.set(this,void 0),h.set(this,void 0),r.set(this,1),n.set(this,d.paused),l.set(this,[]),o.set(this,[]),f.set(this,!1),u.set(this,this.loopVideo.bind(this)),c.set(this,this.private_checkForcedPause.bind(this)),_.set(this,null),p(this,s,t,"f"),p(this,f,t.loop,"f"),p(this,n,t.paused?d.paused:d.playing,"f"),t.loop=!1;const e="requestVideoFrameCallback"in HTMLMediaElement.prototype?"loadedmetadata":"loadeddata";p(this,a,new Promise(((t,e)=>{p(this,h,t,"f")})),"f"),y(this,s,"f")?.addEventListener("canplay",(()=>b.debug("Canplay was fired","purple"))),y(this,s,"f")?.addEventListener("waiting",(()=>b.debug("Waiting was fired","purple"))),y(this,s,"f")?.addEventListener(e,(()=>{b.debug(e+" was fired","purple"),y(this,h,"f")&&y(this,s,"f")&&y(this,h,"f").call(this,y(this,s,"f").duration)}))}getMediaElement(){return y(this,s,"f")}setVolume(t){t!==y(this,r,"f")&&y(this,s,"f")&&(p(this,r,t,"f"),y(this,s,"f").volume=t,y(this,s,"f").muted=t<=0)}async play(){y(this,s,"f")&&(p(this,n,d.playing,"f"),await y(this,a,"f"),y(this,n,"f")===d.playing&&null===y(this,_,"f")&&y(this,s,"f")&&(y(this,s,"f").volume=0,y(this,s,"f").muted=!0,p(this,_,y(this,s,"f").play(),"f"),await y(this,_,"f"),this.private_IOSFix(),p(this,_,null,"f")))}async pause(){y(this,s,"f")&&y(this,n,"f")===d.playing&&(p(this,n,d.paused,"f"),y(this,_,"f")&&await y(this,_,"f"),y(this,n,"f")===d.paused&&y(this,s,"f")&&y(this,s,"f").pause())}async jumpAt(t){y(this,s,"f")&&(y(this,s,"f").volume=0,y(this,s,"f").muted=!0,"fastSeek"in y(this,s,"f")?y(this,s,"f").fastSeek(t):y(this,s,"f").currentTime=t,this.private_IOSFix())}on(t,e){y(this,s,"f")&&"durationchange"!==t&&y(this,s,"f").addEventListener(t,e)}off(t,e){y(this,s,"f")&&"durationchange"!==t&&y(this,s,"f").removeEventListener(t,e)}onDestroy(t){return y(this,o,"f").push(t),this}async stop(){p(this,n,d.paused,"f"),y(this,s,"f")&&(await y(this,s,"f").pause(),y(this,s,"f").currentTime=0)}async getDuration(){return await y(this,a,"f")}getCurrentTime(){return y(this,s,"f")?y(this,s,"f").currentTime:0}onForcedPause(t){return y(this,l,"f").push(t),this}offForcedPause(t){for(var e=0;e<y(this,l,"f").length;e++)if(y(this,l,"f")[e]===t){y(this,l,"f").splice(e,1);break}return this}set loop(t){p(this,f,t,"f"),t?y(this,s,"f").addEventListener("ended",y(this,u,"f")):y(this,s,"f").removeEventListener("ended",y(this,u,"f"))}get loop(){return y(this,f,"f")}get readyState(){return y(this,s,"f").readyState}set playbackRate(t){y(this,s,"f").playbackRate=t}get playbackRate(){return y(this,s,"f")?y(this,s,"f").playbackRate:0}finish(){for(var t of(y(this,s,"f").removeEventListener("pause",y(this,c,"f")),y(this,s,"f").removeEventListener("ended",y(this,u,"f")),y(this,o,"f")))t(void 0);p(this,o,[],"f"),p(this,l,[],"f")}private_IOSFix(){setTimeout((()=>{y(this,s,"f")&&(y(this,s,"f").addEventListener("pause",y(this,c,"f")),setTimeout((()=>{y(this,s,"f")&&y(this,s,"f").removeEventListener("pause",y(this,c,"f"))}),1e3),y(this,s,"f").volume=y(this,r,"f"),y(this,s,"f").muted=y(this,r,"f")<=0)}),250)}async loopVideo(){y(this,s,"f")&&(p(this,n,d.playing,"f"),y(this,s,"f").volume=0,y(this,s,"f").muted=!0,y(this,s,"f").currentTime=0)}private_checkForcedPause(){if(y(this,s,"f")&&y(this,n,"f")===d.playing)for(var t of(y(this,s,"f").removeEventListener("pause",y(this,c,"f")),y(this,l,"f")))t()}};var m,w;!function(t){t.timeupdate="timeupdate",t.durationchange="durationchange",t.ended="ended",t.looping="looping",t.paused="paused",t.playing="playing",t.buffering="buffering",t.buffered="buffered"}(m||(m={})),function(t){t.longest="longest",t.shortest="shortest"}(w||(w={}));var k,v,S,P,j,O,A,L,T,M,E,R,C=function(t,e,i,s,a){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!a:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?a.call(t,i):a?a.value=i:e.set(t,i),i},V=function(t,e,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!s:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(t):s?s.value:e.get(t)};!function(t){t[t.paused=0]="paused",t[t.forcedPause=1]="forcedPause",t[t.buffering=2]="buffering",t[t.playing=3]="playing"}(E||(E={})),function(t){t.error="error",t.buffering="buffering",t.buffered="buffered",t.disposed="disposed"}(R||(R={})),k=new WeakMap,v=new WeakMap,S=new WeakMap,P=new WeakMap,j=new WeakMap,O=new WeakMap,A=new WeakMap,L=new WeakMap,T=new WeakMap,M=new WeakMap;const z=class{constructor(t){k.set(this,E.paused),v.set(this,1),S.set(this,!1),P.set(this,void 0),j.set(this,null),O.set(this,!1),A.set(this,this.loopVideo.bind(this)),L.set(this,this.private_checkForcedPause.bind(this)),T.set(this,[]),M.set(this,null),C(this,P,t,"f"),C(this,k,t.isPaused()?E.paused:E.playing,"f"),C(this,O,t.loop,"f"),V(this,P,"f").loop=!1,V(this,P,"f").on(R.error,(t=>{C(this,S,t,"f"),V(this,j,"f")&&V(this,j,"f").call(this,t)})),V(this,P,"f").on(R.buffering,(()=>C(this,k,E.buffering,"f"))),V(this,P,"f").on(R.buffered,(()=>{V(this,k,"f")!==E.paused&&V(this,k,"f")!==E.forcedPause&&C(this,k,E.playing,"f")}))}getMediaElement(){var t=null;return V(this,P,"f")&&(t=V(this,P,"f").getVideoElement()),t}getRYSKObject(){return V(this,P,"f")}async getDuration(){return V(this,P,"f")?await V(this,P,"f").getDuration():null}async jumpAt(t){V(this,P,"f")&&(V(this,P,"f").setVolume(0),await V(this,P,"f").jumpAt(t),this.private_IOSFix())}getCurrentTime(){return V(this,P,"f")?V(this,P,"f").getCurrentTime():0}on(t,e){V(this,P,"f")&&"durationchange"!==t&&V(this,P,"f").on(t,e)}off(t,e){V(this,P,"f")&&"durationchange"!==t&&V(this,P,"f").off(t,e)}onDestroy(t){return V(this,P,"f")&&V(this,P,"f").on(R.disposed,t),this}onForcedPause(t){return V(this,T,"f").push(t),this}offForcedPause(t){for(var e=0;e<V(this,T,"f").length;e++)if(V(this,T,"f")[e]===t){V(this,T,"f").splice(e,1);break}return this}set loop(t){null!==V(this,P,"f")&&(C(this,O,t,"f"),t?V(this,P,"f").onVideoEvent("ended",V(this,A,"f")):V(this,P,"f").offVideoEvent("ended",V(this,A,"f")))}get loop(){return V(this,O,"f")}get readyState(){return V(this,P,"f")&&V(this,P,"f").firstBuffering?4:0}set playbackRate(t){const e=this.getMediaElement();e&&(e.playbackRate=t)}get playbackRate(){const t=this.getMediaElement();return t?t.playbackRate:0}async play(){if(C(this,k,E.playing,"f"),V(this,P,"f")&&(V(this,P,"f").setVolume(0),await V(this,P,"f").play()),this.private_IOSFix(),V(this,M,"f")){const t=V(this,M,"f");C(this,M,null,"f"),t()}}async pause(){C(this,k,E.paused,"f"),V(this,P,"f")&&await V(this,P,"f").pause()}async stop(){C(this,k,E.paused,"f"),V(this,P,"f")&&await V(this,P,"f").stop()}setVolume(t){t!==V(this,v,"f")&&(C(this,v,t,"f"),V(this,P,"f")&&V(this,P,"f").setVolume(t))}finish(){C(this,T,[],"f"),V(this,P,"f")&&(V(this,P,"f").offVideoEvent("ended",V(this,A,"f")),V(this,P,"f").offVideoEvent("pause",V(this,L,"f")),V(this,P,"f").pause(),C(this,P,null,"f"))}async loopVideo(){null!==V(this,P,"f")&&(C(this,k,E.paused,"f"),V(this,P,"f").setVolume(0),await V(this,P,"f").jumpAt(0))}private_IOSFix(){setTimeout((()=>{null!==V(this,P,"f")&&(V(this,P,"f").onVideoEvent("pause",V(this,L,"f")),setTimeout((()=>{null!==V(this,P,"f")&&V(this,P,"f").offVideoEvent("pause",V(this,L,"f"))}),250),V(this,P,"f").setVolume(V(this,v,"f")))}),250)}private_checkForcedPause(){if(null!==V(this,P,"f")&&V(this,k,"f")===E.playing)for(var t of(V(this,P,"f").offVideoEvent("pause",V(this,L,"f")),V(this,T,"f")))t()}};var F,D,W=function(t,e,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!s:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(t):s?s.value:e.get(t)};try{if(void 0===i)throw"Missing MantisLog from @mantisvision/utils";var B=i.MantisLog}catch(t){B={debug:(...t)=>{}}}const U=-1!==navigator.userAgent.toLocaleLowerCase().indexOf("mac")||-1!==navigator.userAgent.toLocaleLowerCase().indexOf("ios");F=new WeakSet,D=function(){return B.debug("playUser called internally! userstate: "+this._userStatePlay+" libstate: "+this._libStatePlay,"pink","black"),this._playUser()};const q=class{constructor(t,e=w.longest){for(var i of(F.add(this),this._regime=w.longest,this._playbackRate=1,this._timingUpdateHandler=!1,this._destroyed=!1,this._synchronizableObjects=new Map,this._timingObject=null,this._currentTimestamp=0,this._lastSync=-1,this._pausedTimestamp=0,this._syncObjs=new Map,this._looping=new Set,this._ended=new Map,this._buffering=new Map,this._listeners=new Map,this._fullDuration=0,this._firstStart=!0,this._autostart=!1,this._autostartAfter=-1,this._firstBuffered=0,this._paused=!0,this._volume=0,this._checkFrequency=.5,this._resyncing=new WeakMap,this._callbacks=new Map,this._userStatePlay=-1,this._libStatePlay=0,this._promise=null,this._timeupdate=()=>{if(!this._destroyed){if(this._timingUpdateHandler&&this._timingObject&&!this.isPaused()&&1===this._userStatePlay&&1===this._libStatePlay){const i=this._timingObject.query().position,s=i>this._lastSync?i-this._lastSync:this._lastSync-i;if(this._currentTimestamp=i,s>=this._checkFrequency){for(var[t,e]of(this._lastSync=i,this._syncObjs))if(e>=i)if(this._resyncing.has(t)&&U){if(U){let e=this._resyncing.get(t);void 0!==e&&++e>6?this._resyncing.delete(t):this._resyncing.set(t,e??0)}}else{const e=t.getCurrentTime()-i;e<.1&&e>-.1?t.playbackRate!==this._playbackRate&&(t.playbackRate=this._playbackRate,U&&this._resyncing.set(t,0)):e>1||e<-1?(t.playbackRate!==this._playbackRate&&(t.playbackRate=this._playbackRate),U&&this._resyncing.set(t,0),t.jumpAt(i)):e>=.1?(t.playbackRate=e<.3?.9*this._playbackRate:e<.7?.8*this._playbackRate:e<1?.75*this._playbackRate:.7*this._playbackRate,U&&this._resyncing.set(t,0)):(t.playbackRate=e<-1?1.3*this._playbackRate:e<-.7?1.25*this._playbackRate:e<-.3?1.2*this._playbackRate:1.1*this._playbackRate,U&&this._resyncing.set(t,0))}this._callCallbacks(m.timeupdate,i)}}requestAnimationFrame(this._timeupdate)}},this._timingClass=t,this._regime=e,Object.keys(m)))this._callbacks.set(i,new Set);requestAnimationFrame(this._timeupdate)}changeRegime(t){return this._regime=t,this}getCurrentRegime(){return this._regime}setSyncCheckFrequency(t){return this._checkFrequency=t,this}getSyncCheckFrequency(){return this._checkFrequency}setPlaybackRate(t){const e=this._playbackRate;if(this._playbackRate=t,e!==t){const e=this._synchronizableObjects.values();for(var i of e)i.playbackRate=t;this._timingObject?.update({velocity:this._playbackRate})}return this}getPlaybackRate(){return this._playbackRate}getDuration(){return this._fullDuration}getCurrentTimestamp(){return this._currentTimestamp}autoplayAfter(t){return this._destroyed||(B.debug("Play after "+t+" added media","yellow","black"),this._firstStart&&(t-this._buffering.size-this._ended.size-this._syncObjs.size<=0?(this._firstStart=!1,this.play()):this._autostartAfter=t),this.setAutoplay(!0)),this}setLoop(t,e){if(this._destroyed)return this;if(Array.isArray(t))for(var i of t)this.setLoop(i,e);else{const i=this._synchronizableObjects.get(t);if(!i)throw new Error("Media hasn't been added to this VideoSync object (or it was already removed).");this._setLoop(i,e)}return this}isPaused(){return this._paused}isAutoplay(){return this._autostart}setVolume(t,e){if(void 0===e){const e=this._listeners.keys();for(var i of e)i.setVolume(t);this._volume=t}else if(Array.isArray(e))for(var s of e)this.setVolume(t,s);else if(this._synchronizableObjects.has(e)){const i=this._synchronizableObjects.get(e);i?.setVolume(t)}return this}setAutoplay(t){return t&&!this._autostart&&this._firstStart?(this._paused=!1,this._autostart=t,this._checkAutoplay()):this._autostart=t,this}on(t,e){return this._destroyed||this._callbacks.get(t)?.add(e),this}off(t,e){return this._callbacks.get(t)?.delete(e),this}getMedia(){return[...this._synchronizableObjects.keys()]}async addMedia(t){if(!this._destroyed){if(this._firstStart&&this._autostartAfter<0&&this._autostart)if(Array.isArray(t)){const i=[];for(var e of t)this._synchronizableObjects.has(e)||i.push(e);if(!(i.length>0))return;this.autoplayAfter(i.length),t=i}else this.autoplayAfter(1);if(Array.isArray(t)){const e=[];for(var i of t)e.push(this.addMedia(i));await Promise.all(e)}else if(!this._synchronizableObjects.has(t)){let e;e=t instanceof HTMLMediaElement?new g(t):("getMesh"in(s=t)||"getEntity"in s)&&"run"in s?new z(t):t,this._synchronizableObjects.set(t,e),await this._addMedia(e)}var s}}removeMedia(t){if(Array.isArray(t))for(var e of t)this.removeMedia(e);else{const e=this._synchronizableObjects.get(t);e&&(this._removeMedia(e),this._synchronizableObjects.delete(t))}return this}finish(){this._destroyed=!0,this._timingObject&&(this._timingUpdateHandler=!1,this._timingObject.update({velocity:0}),this._timingObject=null);const t=this._listeners.keys();for(var e of t)this._detachAllListeners(e),e.playbackRate=this._playbackRate;for(var i of(this._listeners.clear(),this._looping))i.loop=!0;this._looping.clear(),this._syncObjs.clear(),this._buffering.clear(),this._ended.clear(),this._pivotMedia=void 0,this._callbacks.clear()}async play(){this._destroyed||(this._firstStart&&(this._firstStart=!1),this._paused=!1,B.debug("Played called externally! userstate: "+this._userStatePlay+" libstate: "+this._libStatePlay,"lime","black"),await this._playUser())}async pause(){this._destroyed||(this._paused=!0,B.debug("pause called externally! userstate: "+this._userStatePlay+" libstate: "+this._libStatePlay,"lime","black"),await this._pauseUser())}async jumpAt(t){if(this._destroyed)return;for(var[e,i]of(B.debug("Jumping to "+t,"yellow","black"),await this._pauseLib(),this._timingObject&&this._timingObject.update({position:t,velocity:0}),this._callCallbacks(m.timeupdate,t),this._currentTimestamp=t,this._ended))i>=t&&(this._syncObjs.set(e,i),this._ended.delete(e));const s=[];for(var[a,h]of this._buffering)h>=t?this._syncObjs.set(a,h):(this._ended.set(a,h),s.push(a.jumpAt(h)));this._buffering.clear(),await Promise.allSettled(s),await this._resetSync(t),this._pausedTimestamp>0&&(this._pausedTimestamp=t),this._lookForNewPivotAfterJump(),0===this._buffering.size&&await this._playLib()}async stop(){if(this._destroyed)return;for(var[t,e]of(await this.pause(),this._timingObject&&(this._timingUpdateHandler=!1,this._timingObject.update({velocity:0}),this._timingObject=null,this._callCallbacks(m.timeupdate,0)),this._currentTimestamp=0,this._pausedTimestamp=0,this._ended))this._syncObjs.set(t,e);for(var[i,s]of(this._ended.clear(),this._buffering))this._syncObjs.set(i,s);this._buffering.clear();const a=[];let h=null,r=0;for(var[n,l]of this._syncObjs)a.push(n.stop()),l>r&&(r=l,h=n);h&&h!==this._pivotMedia&&(this._pivotMedia=h,this._fullDuration=r,this._callCallbacks(m.durationchange,r)),await Promise.allSettled(a),await this._playLib()}_setLoop(t,e){B.debug("Setting loop to: "+e,"yellow","black"),t.loop=!1,e?this._looping.add(t):this._looping.delete(t)}async _addMedia(t){if(!this._listeners.has(t)){t.setVolume(this._volume),this._listeners.set(t,new Map),this._setLoop(t,t.loop);const e=await t.getDuration();if(null!==e){t.loop=!1;const i=this._currentTimestamp;let s=!1;e<i&&(B.debug("New Video already ends "+i+" duration is "+e,"yellow","black"),this._ended.set(t,e),s=!0),H(t)?this._attachListenersToSYK(t,e):N(t)&&this._attachListenersToVideo(t,e),this._checkPivotWhenAddingNewMedia(t,e),this._firstStart?this._checkAutoplay():this.isPaused()||-1===this._libStatePlay||-1===this._userStatePlay?await t.pause():s||this.isPaused()||(this._timingObject?await t.play():await W(this,F,"m",D).call(this))}}}_checkPivotWhenAddingNewMedia(t,e){this._regime===w.longest?this._fullDuration<e?(this._fullDuration=e,this._pivotMedia=t,this.firstSynchronization(t,e),this._callCallbacks(m.durationchange,this._fullDuration)):this._currentTimestamp<=e&&this.firstSynchronization(t,e):this._fullDuration>e||0===this._fullDuration?(this._fullDuration=e,this._pivotMedia=t,this._callCallbacks(m.durationchange,this._fullDuration),e<this._currentTimestamp?this._pivotVideoHasEnded(t,e):this.firstSynchronization(t,e)):this._currentTimestamp<=e&&this.firstSynchronization(t,e)}firstSynchronization(t,e){Math.abs(t.getCurrentTime()-this._currentTimestamp)>=.5&&(B.debug("New media jumps to timestamp "+this._currentTimestamp,"yellow","black"),t.jumpAt(this._currentTimestamp))}_removeMedia(t){if(this._listeners.has(t)){this._autostartAfter--;const e=this._buffering.has(t);this._detachAllListeners(t),this._looping.has(t)&&(this._looping.delete(t),t.loop=!0),this._syncObjs.delete(t),this._ended.delete(t),this._buffering.delete(t),this._pivotMedia===t&&this._lookForNewPivot(),this._syncObjs.size+this._ended.size+this._buffering.size===0?(this._timingObject&&(this._timingUpdateHandler=!1,this._timingObject.update({velocity:0}),this._timingObject=null),this._currentTimestamp=0,this._pausedTimestamp=0,this._pivotMedia=void 0,this._fullDuration=0,this._callCallbacks(m.durationchange,0)):e&&0===this._buffering.size&&this._syncObjs.size>0&&this._playLib()}return this}async _loopVideos(){if(this._callCallbacks(m.looping),!this.isPaused()){B.debug("Looping "+this._looping.size+" media","aqua","black"),this._callCallbacks(m.timeupdate,0);const e=[];for(var t of this._looping)t.playbackRate!==this._playbackRate&&(t.playbackRate=this._playbackRate),e.push(t.loopVideo());await Promise.all(e)}}async _resetSync(t=0){const e=[],i=[];for(var[s,a]of this._syncObjs)if(s.playbackRate!==this._playbackRate&&(s.playbackRate=this._playbackRate),a>=t){if(e.push(s.jumpAt(t)),N(s)&&0===t){const t=s.getMediaElement();t&&i.push(t.play())}}else this._ended.set(s,a),await s.jumpAt(a),this._syncObjs.delete(s);await Promise.allSettled(e),await Promise.allSettled(i)}_lookForNewPivotAfterLoop(){let t=null,e=-1;for(var i of(B.debug("Looking for the new pivot from among "+this._ended.size+" ended and "+this._looping.size+" looping","aqua","black"),this._looping)){const s=this._syncObjs.get(i);s&&(-1===e||this._regime===w.longest&&s>e||this._regime===w.shortest&&s<e)&&(e=s,t=i)}t&&t!==this._pivotMedia&&(this._pivotMedia=t,this._fullDuration=e,B.debug("Found the new pivot duration: "+e,"aqua","black"),this._callCallbacks(m.durationchange,e))}_lookForNewPivotAfterJump(){const t=[this._syncObjs.entries(),this._buffering.entries()];let e=null,i=0;for(var s of t)for(let[t,a]of s)(a>i&&this._regime===w.longest||a<i&&this._regime===w.shortest)&&(i=a,e=t);e&&this._pivotMedia!==e&&(this._pivotMedia=e,this._fullDuration=i,this._callCallbacks(m.durationchange,i))}_lookForNewPivot(){for(var t=null,e=-1,i=[this._syncObjs.entries(),this._buffering.entries(),this._ended.entries()],s=0;s<i.length;s++){let a=i[s];for(let[i,h]of a)2===s&&this._looping.has(i)||(-1===e||this._regime===w.longest&&h>e||this._regime===w.shortest&&h<e)&&(e=h,t=i)}return null!==t&&(this._pivotMedia=t,this._fullDuration=e,this._currentTimestamp>e&&this._pivotVideoHasEnded(t,e),this._callCallbacks(m.durationchange,e),!0)}_checkAutoplay(){B.debug("Checking autoplay: "+this._autostart+" First start: "+this._firstStart+" Autostart after: "+this._autostartAfter+" first buffered: "+this._firstBuffered,"aqua","black"),this._autostart&&this._firstStart&&this._autostartAfter>=0&&this._firstBuffered===this._autostartAfter&&(this._firstStart=!1,this._playLib(),this.isPaused()||this.play())}_detachAllListeners(t){const e=this._listeners.get(t);if(e){for(var[i,s]of e)switch(i){case"buffering":H(t)?t.off("buffering",s):N(t)&&t.off("waiting",s);break;case"buffered":H(t)?t.off("buffered",s):N(t)&&t.off("canplaythrough",s);break;case"canplay":H(t)?t.off("dataBuffered",s):N(t)&&t.off("canplaythrough",s);break;case"ended":H(t)?t.off("video.ended",s):N(t)&&t.off("ended",s)}this._listeners.delete(t)}return this}_attachListenersToSYK(t,e){B.debug("Attaching to RYSK object","yellow","black"),this._firstStart?t.readyState<2?(this._buffering.set(t,e),1===this._buffering.size&&this._callCallbacks(m.buffering),this._attachFirstBufferingListenerToSyk(t,e)):(this._syncObjs.set(t,e),this._firstBuffered++,this._checkAutoplay(),(this._firstStart||this.isPaused())&&t.pause()):this._ended.has(t)||this._syncObjs.set(t,e),this._attachBufferingListenerToSyk(t,e)._attachBufferedListenerToSyk(t,e)._attachEndedListenerToSyk(t,e)._attachDurationChangeListener(t)}_attachFirstBufferingListenerToSyk(t,e){const i=this._listeners.get(t);if(!i||i.has("canplay"))throw"Attempt to attach second listener to ended";{const s=()=>{B.debug("RYSK first buffering is finished","yellow","black");const i=this._listeners.get(t);i&&(i.delete("canplay"),t.off("dataBuffered",s),this._currentTimestamp>e?this._ended.set(t,e):this._syncObjs.set(t,e),this._buffering.delete(t),this._firstStart&&this._firstBuffered++,0===this._buffering.size&&(this._playLib(),this.isPaused()||this._firstStart||W(this,F,"m",D).call(this),this._callCallbacks(m.buffered)),this._checkAutoplay())};i.set("canplay",s),t.on("dataBuffered",s)}return this}_attachEndedListenerToSyk(t,e){const i=this._listeners.get(t);if(!i||i.has("ended"))throw"Attempt to attach second listener to video.ended";{const s=()=>{this._videoHasEnded(t,e)};i.set("ended",s),t.on("video.ended",s)}return this}_attachBufferingListenerToSyk(t,e){const i=this._listeners.get(t);if(!i||i.has("buffering"))throw"Attempt to attach second listener to buffering";{const s=()=>{B.debug("Received buffering "+this._ended.has(t),"black","aqua"),this._ended.has(t)||this._buffering.has(t)||(this._buffering.set(t,e),this._syncObjs.delete(t),1===this._buffering.size&&this._callCallbacks(m.buffering),this._pauseLib().then((()=>{B.debug("After pause the "+this._buffering.size+" objects still buffering","yellow","black")})))};i.set("buffering",s),t.on("buffering",s)}return this}_attachBufferedListenerToSyk(t,e){const i=this._listeners.get(t);if(!i||i.has("buffered"))throw"Attempt to attach second listener to buffered";{const s=()=>{!this._ended.has(t)&&this._buffering.has(t)&&(this._currentTimestamp>e?this._ended.set(t,e):this._syncObjs.set(t,e),this._buffering.delete(t),0===this._buffering.size?(this._playLib(),this.isPaused()?t.pause():W(this,F,"m",D).call(this),this._callCallbacks(m.buffered)):-1!==this._userStatePlay&&-1!==this._libStatePlay||t.pause())};i.set("buffered",s),t.on("buffered",s)}return this}_attachDurationChangeListener(t){t.on("durationchange",(()=>{t.getDuration().then((e=>{B.debug("Duration of one of media changes to "+e),null!==e&&(this._syncObjs.has(t)&&this._syncObjs.set(t,e),this._ended.has(t)&&this._ended.set(t,e),this._buffering.has(t)&&this._buffering.set(t,e),e<this._currentTimestamp&&!this._ended.has(t)?(this._syncObjs.delete(t),this._buffering.delete(t),this._ended.set(t,e),t.stop()):e>this._currentTimestamp&&this._ended.has(t)&&(this._ended.delete(t),this._syncObjs.set(t,e),t.jumpAt(this._currentTimestamp).then((()=>{this.isPaused()||-1===this._libStatePlay?t.pause():t.play()}))),t===this._pivotMedia&&(e<this._fullDuration&&this._regime===w.longest||e>this._fullDuration&&this._regime===w.shortest?this._lookForNewPivot()||(this._fullDuration=e,this._callCallbacks(m.durationchange,e),this._pivotVideoHasEnded(t,e)):(this._fullDuration=e,this._callCallbacks(m.durationchange,e))))}))}))}_attachListenersToVideo(t,e){this._firstStart?t.readyState>=4?(B.debug("New video is already in state "+t.readyState,"yellow","black"),this._syncObjs.set(t,e),this._firstBuffered++,this._checkAutoplay(),(this.isPaused()||this._firstStart)&&t.pause()):(t.play(),this._buffering.set(t,e),1===this._buffering.size&&this._callCallbacks(m.buffering),this._attachCanPlayListenerToVideo(t,e)):this._ended.has(t)||this._syncObjs.set(t,e),this._attachEndedListenerToVideo(t,e)._attachBufferingListenerToVideo(t,e)._attachBufferedListenerToVideo(t,e)._attachDurationChangeListener(t)}_attachCanPlayListenerToVideo(t,e){const i=this._listeners.get(t);if(!i||i.has("canplay"))throw"Attempt to attach second listener to ended";{const s=()=>{B.debug("Video first buffering is finished","yellow","black");const i=this._listeners.get(t);i&&(i.delete("canplay"),t.off("canplaythrough",s),this._currentTimestamp>e?this._ended.set(t,e):this._syncObjs.set(t,e),this._buffering.delete(t),this._firstStart&&this._firstBuffered++,0===this._buffering.size&&(this._playLib(),this.isPaused()||this._firstStart||W(this,F,"m",D).call(this),this._callCallbacks(m.buffered)),this._checkAutoplay(),(this._firstStart||this.isPaused())&&t.pause())};i.set("canplay",s),t.on("canplaythrough",s),B.debug("Video first buffering listener attached. Current state is: "+t.readyState,"yellow","black")}return this}_attachEndedListenerToVideo(t,e){const i=this._listeners.get(t);if(!i||i.has("ended"))throw"Attempt to attach second listener to ended";{const s=()=>{this._videoHasEnded(t,e)};i.set("ended",s),t.on("ended",s)}return this}_attachBufferingListenerToVideo(t,e){const i=this._listeners.get(t);if(!i||i.has("buffering"))throw"Attempt to attach second listener to waiting";{const s=()=>{this._firstStart||this._ended.has(t)||(this._pauseLib(),this._buffering.set(t,e),this._syncObjs.delete(t),1===this._buffering.size&&this._callCallbacks(m.buffering))};i.set("buffering",s),t.on("waiting",s)}return this}_attachBufferedListenerToVideo(t,e){const i=this._listeners.get(t);if(!i||i.has("buffered"))throw"Attempt to attach second listener to playing";{const s=()=>{this._firstStart||(this._currentTimestamp>e?this._ended.set(t,e):this._syncObjs.set(t,e),this._buffering.delete(t),0===this._buffering.size?(this._playLib(),this.isPaused()?t.pause():W(this,F,"m",D).call(this),this._callCallbacks(m.buffered)):-1!==this._userStatePlay&&-1!==this._libStatePlay||t.pause())};i.set("buffered",s),t.on("canplaythrough",s)}return this}async _pivotVideoHasEnded(t,e){for(var[i,s]of(B.debug("Pivot video has ended","black","red"),await this._pauseLib(),this._buffering))this._syncObjs.set(i,s);for(var[a,h]of(this._buffering.clear(),this._ended))(this._looping.has(a)||0===this._looping.size)&&(this._syncObjs.set(a,h),this._ended.delete(a));this._currentTimestamp=0,this._pausedTimestamp=0,this._looping.has(t)?(this._timingObject&&this._timingObject.update({position:0,velocity:0}),await this._loopVideos()):this._looping.size>0?(this._syncObjs.delete(t),this._ended.set(t,e),this._lookForNewPivotAfterLoop(),this._timingObject&&this._timingObject.update({position:0,velocity:0}),await this._loopVideos()):(null!==this._timingObject&&(this._timingObject.update({velocity:0}),this._timingObject=null),await this.pause(),this._callCallbacks(m.ended)),await this._playLib()}async _videoHasEnded(t,e){Math.abs(t.getCurrentTime()-e)<.1&&(this._ended.set(t,e),this._syncObjs.delete(t),this._buffering.delete(t),B.debug("Video has ended in timestamp "+t.getCurrentTime()+", "+this._syncObjs.size+" playing","aqua","black"),t===this._pivotMedia&&await this._pivotVideoHasEnded(t,e))}async _playUser(){if(this._promise){this._userStatePlay=0;try{return await this._promise,this._promise=null,void(-1!==this._libStatePlay&&-1!==this._userStatePlay&&(this._userStatePlay=1,this._libStatePlay=1))}catch(t){throw this._promise=null,this._userStatePlay=-1,t}}else{if(this._libStatePlay>-1&&this._userStatePlay>-1){this._userStatePlay=1,this._libStatePlay=1,this._promise=this._playAll();try{await this._promise,this._promise=null,-1!==this._libStatePlay&&-1!==this._userStatePlay&&(this._userStatePlay=1,this._libStatePlay=1)}catch(t){throw this._promise=null,t}return}if(-1===this._libStatePlay)return void(this._userStatePlay=0);if(-1!==this._userStatePlay)throw"Unknown state";this._userStatePlay=0,this._promise=this._playAll();try{return await this._promise,this._promise=null,void(-1!==this._libStatePlay&&-1!==this._userStatePlay&&(this._userStatePlay=1,this._libStatePlay=1))}catch(t){throw this._promise=null,this._userStatePlay=-1,t}}}async _pauseUser(){if(B.debug("pauseUser userstate: "+this._userStatePlay+" libstate: "+this._libStatePlay,"pink","black"),this._userStatePlay=-1,this._promise)try{await this._promise,this._promise=null,-1===this._userStatePlay&&await this._pauseAll()}catch(t){this._promise=null}else await this._pauseAll()}async _playLib(){if(B.debug("playLib userstate: "+this._userStatePlay+" libstate: "+this._libStatePlay,"pink","black"),this._promise){this._libStatePlay=0;try{return await this._promise,this._promise=null,void(-1!==this._libStatePlay&&-1!==this._userStatePlay&&(this._userStatePlay=1,this._libStatePlay=1))}catch(t){throw this._promise=null,this._libStatePlay=-1,t}}else{if(this._libStatePlay>-1&&this._userStatePlay>-1){this._userStatePlay=1,this._libStatePlay=1,this._promise=this._playAll();try{await this._promise,this._promise=null,-1!==this._libStatePlay&&-1!==this._userStatePlay&&(this._userStatePlay=1,this._libStatePlay=1)}catch(t){throw this._promise=null,t}return}if(-1===this._userStatePlay)return void(this._libStatePlay=0);if(-1!==this._libStatePlay)throw"Unknown state";this._libStatePlay=0,this._promise=this._playAll();try{return await this._promise,this._promise=null,void(-1!==this._libStatePlay&&-1!==this._userStatePlay&&(this._userStatePlay=1,this._libStatePlay=1))}catch(t){throw this._promise=null,this._libStatePlay=-1,t}}}async _pauseLib(){if(B.debug("pauseLib userstate: "+this._userStatePlay+" libstate: "+this._libStatePlay,"pink","black"),this._libStatePlay=-1,this._promise)try{await this._promise,this._promise=null,-1===this._libStatePlay&&await this._pauseAll()}catch(t){this._promise=null}else await this._pauseAll()}async _playAll(){if(this._syncObjs.size>0||0===this._synchronizableObjects.size){const e=[],i=this._syncObjs.keys();for(var t of i)e.push(t.play());await Promise.allSettled(e),null!==this._timingObject||this._destroyed?null===this._timingObject||this._destroyed||(-1!==this._libStatePlay&&-1!==this._userStatePlay?(B.debug("PLAY ALL "+this._syncObjs.size+" media after pause","yellow","black"),this._timingObject.update({velocity:this._playbackRate})):B.debug("PLAY ALL ABORTED, "+this._buffering.size+" MEDIA IS BUFFERING. libStatePlay is "+this._libStatePlay+" userStatePlay is "+this._userStatePlay,"red","black")):(B.debug("PLAY ALL "+this._syncObjs.size+" media for the first time","yellow","black"),this._timingObject=new this._timingClass({position:this._currentTimestamp,velocity:this._playbackRate,acceleration:0}),this._timingObject.update({velocity:this._playbackRate}),this._timingUpdateHandler=!0),this._callCallbacks(m.playing)}}async _pauseAll(){this._timingObject&&this._timingObject.update({velocity:0});const t=[];let e=this._synchronizableObjects.values();var i=void 0;for(i of e)t.push(i.pause());await Promise.allSettled(t),B.debug("PAUSE ALL","yellow","black"),this._callCallbacks(m.paused)}_callCallbacks(t,e){const i=this._callbacks.get(t);if(i)for(var s of i)(void 0===e&&0===s.length||void 0!==e&&s.length>0)&&s(e)}};function H(t){return"getRYSKObject"in t&&"getMediaElement"in t}function N(t){return!("getRYSKObject"in t)&&"getMediaElement"in t}window.RyskSynchronizer=e.default})();