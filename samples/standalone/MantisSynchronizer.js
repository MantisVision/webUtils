/*! For license information please see MantisSynchronizer.js.LICENSE.txt */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("@mantisvision/utils")):"function"==typeof define&&define.amd?define("@mantisvision/synchronizer",["@mantisvision/utils"],e):"object"==typeof exports?exports["@mantisvision/synchronizer"]=e(require("@mantisvision/utils")):t["@mantisvision/synchronizer"]=e(t["@mantisvision/utils"])}(self,(t=>(()=>{"use strict";var e={672:e=>{e.exports=t}},s={};function i(t){var a=s[t];if(void 0!==a)return a.exports;var n=s[t]={exports:{}};return e[t](n,n.exports,i),n.exports}i.d=(t,e)=>{for(var s in e)i.o(e,s)&&!i.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var a={};return(()=>{i.r(a),i.d(a,{default:()=>x,isRYSKUrl:()=>g});var t,e,s,n,h,r,l,o,f,u,d,c,_=i(672),p=function(t,e,s,i,a){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!a:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?a.call(t,s):a?a.value=s:e.set(t,s),s},b=function(t,e,s,i){if("a"===s&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!i:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?i:"a"===s?i.call(t):i?i.value:e.get(t)};try{if(void 0===_)throw"Missing MantisLog from @mantisvision/utils";var y=_.MantisLog}catch(t){y={debug:(...t)=>{}}}!function(t){t[t.paused=0]="paused",t[t.playing=1]="playing"}(c||(c={})),t=new WeakMap,e=new WeakMap,s=new WeakMap,n=new WeakMap,h=new WeakMap,r=new WeakMap,l=new WeakMap,o=new WeakMap,f=new WeakMap,u=new WeakMap,d=new WeakMap;const m=class{constructor(i){t.set(this,void 0),e.set(this,void 0),s.set(this,void 0),n.set(this,1),h.set(this,c.paused),r.set(this,[]),l.set(this,[]),o.set(this,!1),f.set(this,this.loopVideo.bind(this)),u.set(this,this.private_checkForcedPause.bind(this)),d.set(this,null),p(this,t,i,"f");const a="requestVideoFrameCallback"in HTMLVideoElement.prototype?"loadedmetadata":"loadeddata";p(this,e,new Promise(((t,e)=>{p(this,s,t,"f")})),"f"),b(this,t,"f")?.addEventListener("canplay",(()=>y.debug("Canplay was fired","purple"))),b(this,t,"f")?.addEventListener("waiting",(()=>y.debug("Waiting was fired","purple"))),b(this,t,"f")?.addEventListener(a,(()=>{y.debug(a+" was fired","purple"),b(this,s,"f")&&b(this,t,"f")&&b(this,s,"f").call(this,b(this,t,"f").duration)}))}getMediaElement(){return b(this,t,"f")}setVolume(e){e!==b(this,n,"f")&&b(this,t,"f")&&(p(this,n,e,"f"),b(this,t,"f").volume=e,b(this,t,"f").muted=e<=0)}async play(){b(this,t,"f")&&(p(this,h,c.playing,"f"),await b(this,e,"f"),b(this,h,"f")===c.playing&&null===b(this,d,"f")&&b(this,t,"f")&&(b(this,t,"f").volume=0,b(this,t,"f").muted=!0,p(this,d,b(this,t,"f").play(),"f"),await b(this,d,"f"),this.private_IOSFix(),p(this,d,null,"f")))}async pause(){b(this,t,"f")&&b(this,h,"f")===c.playing&&(p(this,h,c.paused,"f"),b(this,d,"f")&&await b(this,d,"f"),b(this,h,"f")===c.paused&&b(this,t,"f")&&b(this,t,"f").pause())}jumpAt(e){return b(this,t,"f")&&(b(this,t,"f").volume=0,b(this,t,"f").muted=!0,b(this,t,"f").currentTime=e,this.private_IOSFix()),this}onDestroy(t){return b(this,l,"f").push(t),this}onTimeUpdate(e){return b(this,t,"f")&&b(this,t,"f").addEventListener("timeupdate",e),this}offTimeUpdate(e){return b(this,t,"f")&&b(this,t,"f").removeEventListener("timeupdate",e),this}async stop(){p(this,h,c.paused,"f"),b(this,t,"f")&&(await b(this,t,"f").pause(),b(this,t,"f").currentTime=0)}async getDuration(){return await b(this,e,"f")}getCurrentTime(){return b(this,t,"f")?b(this,t,"f").currentTime:0}onForcedPause(t){return b(this,r,"f").push(t),this}offForcedPause(t){for(var e=0;e<b(this,r,"f").length;e++)if(b(this,r,"f")[e]===t){b(this,r,"f").splice(e,1);break}return this}set loop(e){p(this,o,e,"f"),e?b(this,t,"f").addEventListener("ended",b(this,f,"f")):b(this,t,"f").removeEventListener("ended",b(this,f,"f"))}get loop(){return b(this,o,"f")}set playbackRate(e){b(this,t,"f").playbackRate=e}get playbackRate(){return b(this,t,"f")?b(this,t,"f").playbackRate:0}finish(){for(var e of(b(this,t,"f").removeEventListener("pause",b(this,u,"f")),b(this,t,"f").removeEventListener("ended",b(this,f,"f")),b(this,l,"f")))e(void 0);p(this,l,[],"f"),p(this,r,[],"f")}private_IOSFix(){setTimeout((()=>{b(this,t,"f")&&(b(this,t,"f").addEventListener("pause",b(this,u,"f")),setTimeout((()=>{b(this,t,"f")&&b(this,t,"f").removeEventListener("pause",b(this,u,"f"))}),1e3),b(this,t,"f").volume=b(this,n,"f"),b(this,t,"f").muted=b(this,n,"f")<=0)}),250)}loopVideo(){b(this,t,"f")&&(p(this,h,c.playing,"f"),b(this,t,"f").volume=0,b(this,t,"f").muted=!0,b(this,t,"f").play().then(this.private_IOSFix.bind(this)))}private_checkForcedPause(){if(b(this,t,"f")&&b(this,h,"f")===c.playing)for(var e of(b(this,t,"f").removeEventListener("pause",b(this,u,"f")),b(this,r,"f")))e()}};function g(t){return"getMesh"in t&&"run"in t}var w,v,S,k,j,P,O,L,E,T,M,A,V=function(t,e,s,i,a){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!a:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?a.call(t,s):a?a.value=s:e.set(t,s),s},z=function(t,e,s,i){if("a"===s&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!i:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?i:"a"===s?i.call(t):i?i.value:e.get(t)};!function(t){t[t.paused=0]="paused",t[t.forcedPause=1]="forcedPause",t[t.buffering=2]="buffering",t[t.playing=3]="playing"}(M||(M={})),function(t){t.error="error",t.buffering="buffering",t.buffered="buffered",t.disposed="disposed"}(A||(A={})),w=new WeakMap,v=new WeakMap,S=new WeakMap,k=new WeakMap,j=new WeakMap,P=new WeakMap,O=new WeakMap,L=new WeakMap,E=new WeakMap,T=new WeakMap;const R=class{constructor(t){w.set(this,M.paused),v.set(this,1),S.set(this,!1),k.set(this,void 0),j.set(this,null),P.set(this,!1),O.set(this,this.loopVideo.bind(this)),L.set(this,this.private_checkForcedPause.bind(this)),E.set(this,[]),T.set(this,null),V(this,k,t,"f"),z(this,k,"f").loop=!1,z(this,k,"f").on(A.error,(t=>{V(this,S,t,"f"),z(this,j,"f")&&z(this,j,"f").call(this,t)})),z(this,k,"f").on(A.buffering,(()=>V(this,w,M.buffering,"f"))),z(this,k,"f").on(A.buffered,(()=>{z(this,w,"f")!==M.paused&&z(this,w,"f")!==M.forcedPause&&V(this,w,M.playing,"f")}))}getMediaElement(){var t=null;return z(this,k,"f")&&(t=z(this,k,"f").getVideoElement()),t}getRYSKObject(){return z(this,k,"f")}async getDuration(){return z(this,k,"f")?await z(this,k,"f").getDuration():null}jumpAt(t){return z(this,k,"f")&&(z(this,k,"f").setVolume(0),z(this,k,"f").jumpAt(t).then((()=>{this.private_IOSFix()}))),this}getCurrentTime(){var t=0;if(z(this,k,"f")){const e=z(this,k,"f").getVideoElement();e&&(t=e.currentTime)}return t}onTimeUpdate(t){return z(this,k,"f")&&z(this,k,"f").onVideoEvent("timeupdate",t),this}offTimeUpdate(t){return z(this,k,"f")&&z(this,k,"f").offVideoEvent("timeupdate",t),this}onDestroy(t){return z(this,k,"f")&&z(this,k,"f").on(A.disposed,t),this}onForcedPause(t){return z(this,E,"f").push(t),this}offForcedPause(t){for(var e=0;e<z(this,E,"f").length;e++)if(z(this,E,"f")[e]===t){z(this,E,"f").splice(e,1);break}return this}set loop(t){null!==z(this,k,"f")&&(V(this,P,t,"f"),t?z(this,k,"f").onVideoEvent("ended",z(this,O,"f")):z(this,k,"f").offVideoEvent("ended",z(this,O,"f")))}get loop(){return z(this,P,"f")}set playbackRate(t){const e=this.getMediaElement();e&&(e.playbackRate=t)}get playbackRate(){const t=this.getMediaElement();return t?t.playbackRate:0}async play(){if(V(this,w,M.playing,"f"),z(this,k,"f")&&(z(this,k,"f").setVolume(0),await z(this,k,"f").play()),this.private_IOSFix(),z(this,T,"f")){const t=z(this,T,"f");V(this,T,null,"f"),t()}}async pause(){V(this,w,M.paused,"f"),z(this,k,"f")&&await z(this,k,"f").pause()}async stop(){V(this,w,M.paused,"f"),z(this,k,"f")&&await z(this,k,"f").stop()}setVolume(t){t!==z(this,v,"f")&&(V(this,v,t,"f"),z(this,k,"f")&&z(this,k,"f").setVolume(t))}finish(){V(this,E,[],"f"),z(this,k,"f")&&(z(this,k,"f").offVideoEvent("ended",z(this,O,"f")),z(this,k,"f").offVideoEvent("pause",z(this,L,"f")),z(this,k,"f").pause(),V(this,k,null,"f"))}loopVideo(){null!==z(this,k,"f")&&(V(this,w,M.paused,"f"),z(this,k,"f").setVolume(0),z(this,k,"f").play().then(this.private_IOSFix.bind(this)))}private_IOSFix(){setTimeout((()=>{null!==z(this,k,"f")&&(z(this,k,"f").onVideoEvent("pause",z(this,L,"f")),setTimeout((()=>{null!==z(this,k,"f")&&z(this,k,"f").offVideoEvent("pause",z(this,L,"f"))}),250),z(this,k,"f").setVolume(z(this,v,"f")))}),250)}private_checkForcedPause(){if(null!==z(this,k,"f")&&z(this,w,"f")===M.playing)for(var t of(z(this,k,"f").offVideoEvent("pause",z(this,L,"f")),z(this,E,"f")))t()}};try{if(void 0===_)throw"Missing MantisLog from @mantisvision/utils";var C=_.MantisLog}catch(t){C={debug:(...t)=>{}}}class x{constructor(t){this._synchronizableObjects=new Map,this._timingObject=null,this._currentTimestamp=0,this._pausedTimestamp=0,this._syncObjs=new Map,this._looping=new Set,this._ended=new Map,this._buffering=new Map,this._listeners=new Map,this._fullDuration=0,this._firstStart=!0,this._autostart=!1,this._autostartAfter=-1,this._firstBuffered=0,this._paused=!0,this._callbacks=new Map,this._userStatePlay=-1,this._libStatePlay=0,this._promise=null,this._timeupdate=()=>{if(this._timingObject&&!this.isPaused()&&1===this._userStatePlay&&1===this._libStatePlay){const t=this._timingObject.query().position;if(this._currentTimestamp,this._currentTimestamp=t,t>=.5){const e=this._syncObjs.entries();let s;for(;s=e.next().value;)if(s[1]>=t){const e=s[0].getCurrentTime()-t;e<.5&&e>-.5?1!==s[0].playbackRate&&(s[0].playbackRate=1):e>1.5||e<-1.5?(1!==s[0].playbackRate&&(s[0].playbackRate=1),s[0].jumpAt(t)):s[0].playbackRate=e>=.5?e<.75?.9:e<.9?.8:e<1.2?.75:.7:e<-1.2?1.3:e<-.9?1.25:e<-.75?1.2:1.1}this._callCallbacks("timeupdate",t)}}},this._timingClass=t,this._callbacks.set("timeupdate",new Set),this._callbacks.set("durationchange",new Set)}getDuration(){return this._fullDuration}autoplayAfter(t){this._autostart=!0,C.debug("Play after "+t+" added media","yellow","black"),this._firstStart&&(t-this._buffering.size-this._ended.size-this._syncObjs.size<=0?(this._firstStart=!1,this.play()):this._autostartAfter=t)}setLoop(t,e){if(Array.isArray(t))for(var s of t)this.setLoop(s,e);else{const s=this._synchronizableObjects.get(t);if(!s)throw new Error("Media hasn't been added to this VideoSync object (or it was already removed).");this._setLoop(s,e)}return this}isPaused(){return this._paused}isAutoplay(){return this._autostart}setAutoplay(t){return t&&!this._autostart&&this._firstStart?(this._paused=!1,this._autostart=t,this._checkAutoplay()):this._autostart=t,this}on(t,e){this._callbacks.has(t)&&this._callbacks.get(t)?.add(e)}off(t,e){this._callbacks.has(t)&&this._callbacks.get(t)?.delete(e)}getMedia(){return[...this._synchronizableObjects.keys()]}async addMedia(t){if(this._firstStart&&this._autostartAfter<0)if(Array.isArray(t)){if(!(t.length>0))return this;this.autoplayAfter(t.length)}else this.autoplayAfter(1);if(Array.isArray(t)){const s=[];for(var e of t)s.push(this.addMedia(e));await Promise.all(s)}else if(!this._synchronizableObjects.has(t)){let e;e=t instanceof HTMLVideoElement?new m(t):g(t)?new R(t):t,this._synchronizableObjects.set(t,e),await this._addMedia(e)}return this}removeMedia(t){if(Array.isArray(t))for(var e of t)this.removeMedia(e);else{const e=this._synchronizableObjects.get(t);e&&(this._removeMedia(e),this._synchronizableObjects.delete(t))}return this}_setLoop(t,e){C.debug("Setting loop to: "+e,"yellow","black"),t.loop=!1,e?this._looping.add(t):this._looping.delete(t)}async _addMedia(t){if(!this._listeners.has(t)){this._listeners.set(t,new Map),this._setLoop(t,t.loop);const e=await t.getDuration();if(C.debug("Is this paused? "+this.isPaused(),"aqua","black"),null!==e){t.loop=!1,t instanceof R?this._attachListenersToSYK(t,e):t instanceof m&&this._attachListenersToVideo(t,e);const s=this._currentTimestamp;this._fullDuration<e?(this._fullDuration=e,this._longestMedia=t,t.getCurrentTime()!==s&&(C.debug("New media jumps to timestamp "+s,"yellow","black"),t.jumpAt(s)),this._callCallbacks("durationchange",this._fullDuration)):s<=e?t.getCurrentTime()!==s&&(C.debug("New media jumps to timestamp "+s,"yellow","black"),t.jumpAt(s)):(C.debug("New Video already ends "+s+" duration is "+e,"yellow","black"),this._ended.set(t,e)),this._firstStart?this._checkAutoplay():this.isPaused()?t.pause():t.play()}}}_removeMedia(t){if(this._listeners.has(t)){this._autostartAfter--;const n=this._buffering.has(t);if(this._detachAllListeners(t),this._looping.has(t)&&(this._looping.delete(t),t.loop=!0),this._syncObjs.delete(t),this._ended.delete(t),this._buffering.delete(t),this._longestMedia===t){var e=null,s=0,i=[this._syncObjs.entries(),this._buffering.entries(),this._ended.entries()];for(var a of i){let t;for(;t=a.next().value;)t[1]>s&&(s=t[1],e=t[0])}null!==e&&(this._longestMedia=e,this._fullDuration=s,this._currentTimestamp>s&&this._lastVideoHasEnded(e,s),this._callCallbacks("durationchange",s))}this._syncObjs.size+this._ended.size+this._buffering.size===0?(this._timingObject&&(this._timingObject.off("timeupdate",this._timeupdate),this._timingObject=null),this._currentTimestamp=0,this._pausedTimestamp=0,this._longestMedia=void 0,this._fullDuration=0,this._callCallbacks("durationchange",0)):n&&0===this._buffering.size&&this._syncObjs.size>0&&this._playLib()}return this}finish(){this._timingObject&&(this._timingObject.off("timeupdate",this._timeupdate),this._timingObject=null),this._listeners.forEach(((t,e)=>{this._detachAllListeners(e)})),this._listeners.clear(),this._syncObjs.forEach(((t,e)=>{e.loop=!0})),this._syncObjs.clear(),this._buffering.clear(),this._ended.clear(),this._longestMedia=void 0,this._callbacks.clear(),this._looping.forEach((t=>t.loop=!0)),this._looping.clear()}async play(){this._firstStart&&(this._firstStart=!1),await this._playUser(),this._paused=!1}async pause(){await this._pauseUser(),this._paused=!0}async jumpAt(t){C.debug("Jumping to "+t,"yellow","black"),await this._pauseLib(),this._callCallbacks("timeupdate",t),this._currentTimestamp=t,this._ended.forEach(((e,s)=>{e>=t&&(this._syncObjs.set(s,e),this._ended.delete(s))})),this._buffering.forEach(((e,s)=>{e>=t?this._syncObjs.set(s,e):this._ended.set(s,e)})),this._buffering.clear(),C.debug("Jump to "+t+" Ended are "+this._ended.size+" and SyncObj are "+this._syncObjs.size,"aqua","black"),await this._resetSync(t),this._pausedTimestamp>0&&(this._pausedTimestamp=t);const e=this._syncObjs.entries();let s,i=null,a=0;for(;s=e.next().value;)s[1]>a&&(a=s[1],i=s[0]);if(i&&(this._longestMedia=i,this._fullDuration=a,this._callCallbacks("durationchange",a)),this._timingObject&&(this._timingObject.update({position:t,velocity:1}),0===t))try{this._timingObject.on("timeupdate",this._timeupdate)}catch(t){console.log("timeupdate already attached")}await this._playLib()}async stop(){await this.pause(),this._timingObject&&(this._timingObject.off("timeupdate",this._timeupdate),this._timingObject=null,this._callCallbacks("timeupdate",0)),this._currentTimestamp=0,this._pausedTimestamp=0,this._ended.forEach(((t,e)=>{this._syncObjs.set(e,t)})),this._ended.clear(),this._buffering.forEach(((t,e)=>{this._syncObjs.set(e,t)})),this._buffering.clear();const t=[],e=this._syncObjs.entries();let s,i=null,a=0;for(;s=e.next().value;)t.push(s[0].stop()),s[1]>a&&(a=s[1],i=s[0]);i&&i!==this._longestMedia&&(this._longestMedia=i,this._fullDuration=a,this._callCallbacks("durationchange",a)),await Promise.allSettled(t),await this._playLib()}async _loopVideos(){var t=this._looping.values();let e;for(C.debug("Looping "+this._looping.size+" media","aqua","black");e=t.next().value;)1!==e.playbackRate&&(e.playbackRate=1),e.loopVideo()}async _resetSync(t=0){const e=[];var s=this._syncObjs.entries();let i;for(;i=s.next().value;)if(1!==i[0].playbackRate&&(i[0].playbackRate=1),i[1]>=t)if(i[0]instanceof R){const s=i[0].getRYSKObject();s&&e.push(s.jumpAt(t))}else{const s=i[0].getMediaElement();s&&(t>0?"fastSeek"in s?s.fastSeek(t):s.currentTime=t:e.push(s.play()))}else this._ended.set(i[0],i[1]),this._syncObjs.delete(i[0]);await Promise.allSettled(e)}_lookForLongestAfterLoop(){let t,e=this._looping.values(),s=null,i=0;for(C.debug("Looking for the new longest from among "+this._ended.size+" ended and "+this._looping.size+" looping","aqua","black");t=e.next().value;){const e=this._syncObjs.get(t);e&&(e>i||null===s)&&(i=e,s=t)}s&&s!==this._longestMedia&&(this._longestMedia=s,this._fullDuration=i,C.debug("Found the new longest duration: "+i,"aqua","black"),this._callCallbacks("durationchange",i))}_checkAutoplay(){C.debug("Checking autoplay -- First start: "+this._firstStart+" Autostart after: "+this._autostartAfter+" first buffered: "+this._firstBuffered,"aqua","black"),this._autostart&&this._firstStart&&this._autostartAfter>=0&&this._firstBuffered===this._autostartAfter&&(this._firstStart=!1,this._playLib(),this.isPaused()||this.play())}_detachAllListeners(t){const e=this._listeners.get(t);if(e){const s=e.entries();let i;for(;i=s.next().value;)switch(i[0]){case"timeupdate":t.offTimeUpdate(i[1]);break;case"buffering":t instanceof R?t.getRYSKObject()?.off("buffering",i[1]):t.getMediaElement()?.removeEventListener("waiting",i[1]);break;case"buffered":t instanceof R?t.getRYSKObject()?.off("buffered",i[1]):t.getMediaElement()?.removeEventListener("playing",i[1]);break;case"canplay":t instanceof R?t.getRYSKObject()?.off("dataBuffered",i[1]):t.getMediaElement()?.removeEventListener("canplay",i[1]);break;case"ended":t instanceof R?t.getRYSKObject()?.off("videoEnded",i[1]):t.getMediaElement()?.removeEventListener("ended",i[1])}this._listeners.delete(t)}return this}_attachListenersToSYK(t,e){const s=t.getRYSKObject();s&&(C.debug("Attaching to RYSK object","yellow","black"),this._firstStart?!1===s.firstBuffering?(this._buffering.set(t,e),this._attachFirstBufferingListenerToSyk(t,e)):(this._syncObjs.set(t,e),this._firstBuffered++,this._checkAutoplay()):this._syncObjs.set(t,e),this._attachBufferingListenerToSyk(t,e)._attachBufferedListenerToSyk(t,e)._attachEndedListenerToSyk(t,e))}_attachFirstBufferingListenerToSyk(t,e){const s=this._listeners.get(t);if(!s||s.has("canplay"))throw"Attempt to attach second listener to ended";{const i=()=>{const s=this._listeners.get(t);s&&(s.delete("canplay"),t.getRYSKObject()?.off("dataBuffered",i),this._currentTimestamp>e?this._ended.set(t,e):this._syncObjs.set(t,e),this._buffering.delete(t),this._firstStart?this._firstBuffered++:0===this._buffering.size&&(this._playLib(),this.isPaused()||this._playUser()),this._checkAutoplay())};s.set("canplay",i),t.getRYSKObject()?.on("dataBuffered",i)}return this}_attachEndedListenerToSyk(t,e){const s=this._listeners.get(t);if(!s||s.has("ended"))throw"Attempt to attach second listener to video.ended";{const i=()=>{this._videoHasEnded(t,e)};s.set("ended",i),t.getRYSKObject()?.on("video.ended",i)}return this}_attachBufferingListenerToSyk(t,e){const s=this._listeners.get(t);if(!s||s.has("buffering"))throw"Attempt to attach second listener to buffering";{const i=()=>{this._ended.has(t)||(this._buffering.set(t,e),this._syncObjs.delete(t),this._pauseLib().then((()=>{C.debug("After pause the "+this._buffering.size+" objects still buffering","yellow","black")})))};s.set("buffering",i),t.getRYSKObject()?.on("buffering",i)}return this}_attachBufferedListenerToSyk(t,e){const s=this._listeners.get(t);if(!s||s.has("buffered"))throw"Attempt to attach second listener to buffered";{const i=()=>{!this._ended.has(t)&&this._buffering.has(t)&&(this._currentTimestamp>e?this._ended.set(t,e):this._syncObjs.set(t,e),this._buffering.delete(t),0===this._buffering.size?(this._playLib(),this.isPaused()||this._playUser()):-1!==this._userStatePlay&&-1!==this._libStatePlay||t.pause())};s.set("buffered",i),t.getRYSKObject()?.on("buffered",i)}return this}_attachListenersToVideo(t,e){const s=t.getMediaElement();s&&(this._firstStart?s.readyState>=2?(C.debug("New video is already in state "+s.readyState,"yellow","black"),this._syncObjs.set(t,e),this._firstBuffered++,this._checkAutoplay()):(t.play(),this._buffering.set(t,e),this._attachCanPlayListenerToVideo(t,e)):this._syncObjs.set(t,e),this._attachEndedListenerToVideo(t,e)._attachBufferingListenerToVideo(t,e)._attachBufferedListenerToVideo(t,e))}_attachCanPlayListenerToVideo(t,e){const s=this._listeners.get(t);if(!s||s.has("canplay"))throw"Attempt to attach second listener to ended";{const i=()=>{C.debug("Video first buffering is finished","yellow","black");const s=this._listeners.get(t);s&&(s.delete("canplay"),t.getMediaElement()?.removeEventListener("canplay",i),this._currentTimestamp>e?this._ended.set(t,e):this._syncObjs.set(t,e),this._buffering.delete(t),this._firstStart?this._firstBuffered++:0===this._buffering.size&&(this._playLib(),this.isPaused()||this._playUser()),this._checkAutoplay(),this._firstStart&&t.pause())};s.set("canplay",i),t.getMediaElement()?.addEventListener("canplay",i),C.debug("Video first buffering listener attached. Current state is: "+t.getMediaElement()?.readyState,"yellow","black")}return this}_attachEndedListenerToVideo(t,e){const s=this._listeners.get(t);if(!s||s.has("ended"))throw"Attempt to attach second listener to ended";{const i=()=>{this._videoHasEnded(t,e)};s.set("ended",i),t.getMediaElement()?.addEventListener("ended",i)}return this}_attachBufferingListenerToVideo(t,e){const s=this._listeners.get(t);if(!s||s.has("buffering"))throw"Attempt to attach second listener to waiting";{const i=()=>{this._firstStart||this._ended.has(t)||(this._pauseLib(),this._buffering.set(t,e),this._syncObjs.delete(t))};s.set("buffering",i),t.getMediaElement()?.addEventListener("waiting",i)}return this}_attachBufferedListenerToVideo(t,e){const s=this._listeners.get(t);if(!s||s.has("buffered"))throw"Attempt to attach second listener to playing";{const i=()=>{this._firstStart||(this._currentTimestamp>e?this._ended.set(t,e):this._syncObjs.set(t,e),this._buffering.delete(t),0===this._buffering.size?(this._playLib(),this.isPaused()||this._playUser()):-1!==this._userStatePlay&&-1!==this._libStatePlay||t.pause())};s.set("buffered",i),t.getMediaElement()?.addEventListener("canplay",i)}return this}async _lastVideoHasEnded(t,e){this._buffering.forEach(((t,e)=>{this._syncObjs.set(e,t)})),this._buffering.clear(),this._ended.forEach(((t,e)=>{(this._looping.has(e)||0===this._looping.size)&&(this._syncObjs.set(e,t),this._ended.delete(e))})),await this._pauseLib(),this._currentTimestamp=0,this._pausedTimestamp=0,this._loopVideos(),this._callCallbacks("timeupdate",0),this._looping.has(t)?this._timingObject&&(this._timingObject.update({position:0,velocity:1}),this._timingObject.on("timeupdate",this._timeupdate)):this._looping.size>0?(this._syncObjs.delete(t),this._ended.set(t,e),this._lookForLongestAfterLoop(),this._timingObject&&(this._timingObject.update({position:0,velocity:1}),this._timingObject.on("timeupdate",this._timeupdate))):(this._timingObject=null,await this.pause()),await this._playLib()}async _videoHasEnded(t,e){1===this._syncObjs.size?await this._lastVideoHasEnded(t,e):(this._ended.set(t,e),this._syncObjs.delete(t),this._buffering.delete(t))}async _playUser(){if(C.debug("playUser userstate: "+this._userStatePlay+" libstate: "+this._libStatePlay,"pink","black"),this._promise){this._userStatePlay=0;try{return await this._promise,this._promise=null,void(-1!==this._libStatePlay&&-1!==this._userStatePlay&&(this._userStatePlay=1,this._libStatePlay=1))}catch(t){throw this._promise=null,this._userStatePlay=-1,t}}else{if(this._libStatePlay>-1&&this._userStatePlay>-1){this._userStatePlay=1,this._libStatePlay=1,this._promise=this._playAll();try{await this._promise,this._promise=null,-1!==this._libStatePlay&&-1!==this._userStatePlay&&(this._userStatePlay=1,this._libStatePlay=1)}catch(t){throw this._promise=null,t}return}if(-1===this._libStatePlay)return void(this._userStatePlay=0);if(-1!==this._userStatePlay)throw"Unknown state";this._userStatePlay=0,this._promise=this._playAll();try{return await this._promise,this._promise=null,void(-1!==this._libStatePlay&&-1!==this._userStatePlay&&(this._userStatePlay=1,this._libStatePlay=1))}catch(t){throw this._promise=null,this._userStatePlay=-1,t}}}async _pauseUser(){if(C.debug("pauseUser userstate: "+this._userStatePlay+" libstate: "+this._libStatePlay,"pink","black"),this._userStatePlay=-1,this._promise)try{await this._promise,this._promise=null,-1===this._userStatePlay&&await this._pauseAll()}catch(t){this._promise=null}else await this._pauseAll()}async _playLib(){if(C.debug("playLib userstate: "+this._userStatePlay+" libstate: "+this._libStatePlay,"pink","black"),this._promise){this._libStatePlay=0;try{return await this._promise,this._promise=null,void(-1!==this._libStatePlay&&-1!==this._userStatePlay&&(this._userStatePlay=1,this._libStatePlay=1))}catch(t){throw this._promise=null,this._libStatePlay=-1,t}}else{if(this._libStatePlay>-1&&this._userStatePlay>-1){this._userStatePlay=1,this._libStatePlay=1,this._promise=this._playAll();try{await this._promise,this._promise=null,-1!==this._libStatePlay&&-1!==this._userStatePlay&&(this._userStatePlay=1,this._libStatePlay=1)}catch(t){throw this._promise=null,t}return}if(-1===this._userStatePlay)return void(this._libStatePlay=0);if(-1!==this._libStatePlay)throw"Unknown state";this._libStatePlay=0,this._promise=this._playAll();try{return await this._promise,this._promise=null,void(-1!==this._libStatePlay&&-1!==this._userStatePlay&&(this._userStatePlay=1,this._libStatePlay=1))}catch(t){throw this._promise=null,this._libStatePlay=-1,t}}}async _pauseLib(){if(C.debug("pauseLib userstate: "+this._userStatePlay+" libstate: "+this._libStatePlay,"pink","black"),this._libStatePlay=-1,this._promise)try{await this._promise,this._promise=null,-1===this._libStatePlay&&await this._pauseAll()}catch(t){this._promise=null}else await this._pauseAll()}async _playAll(){if(this._syncObjs.size>0){null===this._timingObject?(C.debug("PLAY ALL "+this._syncObjs.size+" media for the first time","yellow","black"),this._timingObject=new this._timingClass({vector:{position:this._currentTimestamp,velocity:1}}),this._timingObject.on("timeupdate",this._timeupdate)):this._pausedTimestamp>0?(C.debug("PLAY ALL "+this._syncObjs.size+" media after pause, Paused timestamp was: "+this._pausedTimestamp,"yellow","black"),this._timingObject.update({position:this._pausedTimestamp,velocity:1}),this._pausedTimestamp=0,this._timingObject.on("timeupdate",this._timeupdate)):C.debug("PLAY ALL "+this._syncObjs.size+" media","yellow","black");const t=this._syncObjs.entries();let e;for(;e=t.next().value;)e[0].play();C.debug("PLAY ALL FINISHED","yellow","black")}}async _pauseAll(){C.debug("PAUSE ALL","yellow","black"),this._timingObject&&0===this._pausedTimestamp&&(this._pausedTimestamp=this._timingObject.query().position,this._timingObject.off("timeupdate",this._timeupdate));const t=[];this._syncObjs.forEach(((e,s)=>{t.push(s.pause())})),this._ended.forEach(((e,s)=>{t.push(s.pause())})),await Promise.allSettled(t)}_callCallbacks(t,e){const s=this._callbacks.get(t);if(s){const t=s.values();let i;for(;i=t.next().value;)i(e)}}}})(),a})()));